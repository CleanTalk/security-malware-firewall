<?php
/**
 * @package Security & Firewall 
 * @version 1.0
 */
/*
Plugin Name: Security & Malware Firewall 
Plugin URI: https://wordpress.org/plugins/security-malware-firewall/ 
Description: The plugin temporary restricts attempts to login to WordPress backend. The restriction is rising for a few seconds if an account failed to login.  
Author: Denis Shagy
Version: 1.2.2
Author URI: https://cleantalk.org
*/

//
// To avoid issue with variable scope in activation hook.
// https://wordpress.org/support/topic/register_activation_hook-and-global-variables?replies=11
//
global $spbc_auth_logs_table_label;

$spbc_plugin_name = 'Security & Malware Firewall';

$spbc_auth_logs_table_label = 'spbc_auth_logs';
$spbc_login_attempts_label = 'spbc_login_attempts'; 

$spbc_attempts_max_fails = 5; // Limit of failed attempts before restrict access to backend. 
$spbc_attempts_calc_period = 3600; // Time interval to count failed attempts. 
$spbc_attempts_sleep_usual = 3; // Give a delay before attempts to login.
$spbc_attempts_sleep_long = 10; // Give a delay before attempts to login.

$spbc_tpl = array(); // Templates for all functions

register_activation_hook( __FILE__, 'spbc_activation' );
add_filter('authenticate', 'spbc_authenticate', 99, 3);
add_action('wp_logout', 'spbc_wp_logout');

add_action('plugins_loaded', 'spbc_plugin_loaded');


//
// Test an attempt to get authed in WordPress backend.
//
function spbc_authenticate($user, $username, $password) {
    global $spbc_login_attempts_label, $spbc_attempts_max_fails, $spbc_attempts_sleep_usual, $spbc_attempts_sleep_long;

    if(is_wp_error($user)) {

        $err_codes = $user->get_error_codes();
        if (in_array( 'incorrect_password', $err_codes )) {
            $spbc_login_attempts = get_option($spbc_login_attempts_label);
            if (is_array($spbc_login_attempts)) {
                
                if (isset($spbc_login_attempts[$username])) {
                    if ($spbc_login_attempts[$username]['attempts'] >= $spbc_attempts_max_fails) {
                        spbc_add_issue($username, $password, $spbc_login_attempts);
                        sleep ($spbc_attempts_sleep_long);
                    } else {
                        spbc_add_issue($username, $password, $spbc_login_attempts);
                    }
                } else {
                    spbc_add_issue($username, $password, $spbc_login_attempts, true);
                }
            } else {
                spbc_add_issue($username, $password, $spbc_login_attempts, true);
            }
            sleep ($spbc_attempts_sleep_usual);
        }
    }
    
    // The user is logged in.
    if (isset($user->ID) && $user->ID > 0) {
        spbc_auth_log(array(
            'username' => $username,
            'event' => 'login'
        ));
    }

    return $user;
}

// Adds a record to failed logins.
function spbc_add_issue($username, $password, $attempts, $new_issue = false) {
    global $spbc_login_attempts_label, $spbc_attempts_calc_period, $wpdb, $spbc_auth_logs_table_label;
    
    // Reset the data to avaoid PHP issues.
    if (!isset($attempts) || !count($attempts)) {
        $attempts = array();
    }
    
    if (isset($attempts[$username]['first_issue']) && time() - $attempts[$username]['first_issue'] > $spbc_attempts_calc_period) {
        $new_issue = true;
        unset($attempts[$username]);
    }

    $update_option = false;
    if ($new_issue) {
        $attempts[$username]['attempts'] = 1;
        $attempts[$username]['first_issue'] = time();
        $attempts[$username]['passwords'][] = md5($password);
        $update_option = true;
    } else {

        // Increase attempts only if new password failed.
        if (!in_array(md5($password), $attempts[$username]['passwords'])) {
            $attempts[$username]['attempts']++;
            $attempts[$username]['passwords'][] = md5($password);
            $update_option = true;
        }
    }
    
    if ($update_option) {
        update_option($spbc_login_attempts_label, $attempts);
        spbc_auth_log(array(
            'username' => $username,
            'event' => 'auth_failed'
        ));
    }

    return null;
}

//
// The function logs any attempt to log in the WordPress backend.
//
function spbc_auth_log ($params = null) {
    global $wpdb, $spbc_auth_logs_table_label;
    
    $params_def = array(
        'username' => null,
        'event' => null,
    );
    $params = array_merge($params_def, $params);

    $auth_ip = null;
    if (function_exists( 'filter_var' )) {
        // The plugin doesn't use any IP from HTTP* headers, because these types of IPs can be spoofed.
        if (isset($_SERVER['REMOTE_ADDR']) && filter_var( $_SERVER['REMOTE_ADDR'], FILTER_VALIDATE_IP, FILTER_FLAG_IPV4 )) {
            $auth_ip = $_SERVER['REMOTE_ADDR'];
        }
    }

    $spbc_auth_logs_table = $wpdb->prefix . $spbc_auth_logs_table_label;
    $values = array(
        'datetime' => date("Y-m-d H:i:s"), 
        'user_login' => $params['username'],
        'event' => $params['event'],
        'auth_ip' => $auth_ip ? ip2long($auth_ip) : null 
    );
    $result = $wpdb->insert(
        $spbc_auth_logs_table,
        $values
    );
    return null;
}

//
// A code during plugin activation.
//
function spbc_activation () {
    global $wpdb, $spbc_auth_logs_table_label;

    $spbc_auth_logs_table = $wpdb->prefix . $spbc_auth_logs_table_label;

    $sql = sprintf("CREATE TABLE IF NOT EXISTS `%s` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `datetime` datetime NOT NULL,
  `user_login` varchar(60) NOT NULL,
  `event` enum('login','logout','auth_failed') NOT NULL,
  `auth_ip` int(10) unsigned DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `datetime` (`datetime`,`event`)
) ENGINE=MyISAM  DEFAULT CHARSET=latin1 AUTO_INCREMENT=1;",
        $spbc_auth_logs_table 
    ); 
    $wpdb->query($sql);
    if (! wp_next_scheduled ( 'spbc_send_daily_report_hook' )) {
        wp_schedule_event(time(), 'daily', 'spbc_send_daily_report_hook' );
    }    
    
    return null;
}

add_action('spbc_send_daily_report_hook', 'spbc_send_daily_report');


//
// Logs a logout event
//
function spbc_wp_logout() {
    $user = wp_get_current_user();

    // The user is logged out.
    if (isset($user->ID) && $user->ID > 0) {
        spbc_auth_log(array(
            'username' => $user->get('user_login'), 
            'event' => 'logout'
        ));
    }

    return null;
}

//
// The functions sends daily reports about attempts to login. 
//
function spbc_send_daily_report ($skip_data_rotation = false) {
    global $wpdb, $spbc_auth_logs_table_label, $spbc_plugin_name, $spbc_tpl;
    
    include_once("templates/spbc_send_daily_report.php");

    // Hours
    $report_interval = 24 * 7;

	$admin_email = get_option('admin_email');
    if (!$admin_email) {
        error_log(sprintf('%s: can\'t send the Daily report because of empty Admin email. File: %s, line %d.',
            $spbc_plugin_name,
            __FILE__,
            __LINE__
        ));
        return false;
    }

    $spbc_auth_logs_table = $wpdb->prefix . $spbc_auth_logs_table_label;
    $sql = sprintf('select id,datetime,user_login,event,auth_ip from %s where datetime between now() - interval %d hour and now();',
        $spbc_auth_logs_table,
        $report_interval
    );
    $rows = $wpdb->get_results($sql);
    foreach ($rows as $k => $v) {
        if (isset($v->datetime))
            $v->datetime_ts = strtotime($v->datetime);
        $rows[$k] = $v;
    }
    usort($rows, function($a, $b) {
        return $b->datetime_ts - $a->datetime_ts;
    });

    $record_datetime = time();
    $events = array();
    $auth_failed_events = array();
    $auth_failed_count = 0;
    foreach ($rows as $record) {
        if (strtotime($record->datetime) > $record_datetime) {
            $record_datetime = strtotime($record->datetime);
        }
        $events[$record->event][$record->user_login][] = array(
            'datetime' => $record->datetime,
            'auth_ip' => long2ip($record->auth_ip),
            'user_login' => $record->user_login
        );
        
        switch ($record->event) {
            case 'auth_failed':
                $auth_failed_events[$record->user_login][$record->auth_ip] = array(
                    'attempts' => isset($auth_failed_events[$record->user_login][$record->auth_ip]['attempts']) ? $auth_failed_events[$record->user_login][$record->auth_ip]['attempts'] + 1 : 1, 
                    'auth_ip' => long2ip($record->auth_ip),
                    'user_login' => $record->user_login
                );
                $auth_failed_count++;
                break;
        }
    }

    $event_part = '';
    $auth_failed_part = sprintf("<p style=\"color: #666;\">%s</p>",
        _("0 brute force attacks have been made for past day.")
    );
    if ($auth_failed_count) {
        foreach ($auth_failed_events as $e) {
            $ip_part = '';
            foreach ($e as $ip) {
                $ip_part .= sprintf("<a href=\"https://cleantalk.org/blacklists/%s\">%s</a> (%d)<br />",
                    $ip['auth_ip'],
                    $ip['auth_ip'],
                    $ip['attempts']
                );
            }
            $event_part .= sprintf($spbc_tpl['event_part_tpl'],
                $ip['user_login'],
                $ip_part
            );
        } 
        $auth_failed_part = sprintf($spbc_tpl['auth_failed_part'],
            $event_part
        );
    } 
    
    $logins_part = sprintf("<p style=\"color: #666;\">%s</p>",
        _('0 users have been logged in for past day.')
    );
    if (isset($events['login']) && count($events['login'])) {
        $event_part = '';
        foreach ($events['login'] as $user_login => $e) {
            $l_part = '';
            foreach ($e as $e2) {
                $l_part .= sprintf("%s, <a href=\"https://cleantalk.org/blacklists/%s\">%s</a><br />",
                    date("M d Y H:i:s", strtotime($e2['datetime'])),
                    $e2['auth_ip'],
                    $e2['auth_ip']
                );
            }
            $event_part .= sprintf($event_part_tpl,
                $user_login,
                $l_part
            );
        }
        $logins_part = sprintf($spbc_tpl['logins_part_tpl'],
            $event_part
        );
    }
    
    $title_main_part = _('Daily security report');
    $subject = sprintf('%s %s',
        parse_url(get_option('siteurl'),PHP_URL_HOST), 
        $title_main_part
    );
    
    $message_anounce = sprintf(_('%s brute force attacks or failed logins, %d successful logins.'),
        number_format($auth_failed_count, 0, ',', ' '),
        isset($events['login']) ? count($events['login']) : 0
    );


    $message = sprintf($spbc_tpl['message_tpl'],
        $spbc_tpl['message_style'],
        $title_main_part,
        $message_anounce,
        $auth_failed_part,
        $logins_part,
        $spbc_plugin_name
    );


    $headers = array('Content-Type: text/html; charset=UTF-8');
    wp_mail(
        $admin_email,
        $subject,
        $message,
        $headers
    );
    
    if (!$skip_data_rotation) {
        $sql = sprintf("delete from %s where datetime <= '%s';",
           $spbc_auth_logs_table,
           date("Y-m-d H:i:s", $record_datetime)
        );
        $wpdb->query($sql);
    };

    return null;
}

//
// Misc functions to test the plugin.
//
function spbc_plugin_loaded() {
    if (isset($_GET['spbc_test_daily_report'])) {
        spbc_send_daily_report(true); 
    }
    
    return null;
}
?>
