<?php

namespace CleantalkSP\Common\FSWatcher;

use CleantalkSP\Common\FSWatcher\Repository\Repository;

class Service
{
    public static function isMinIntervalPassed($interval)
    {
        $journal = Repository::getLastJournal();
        if (is_null($journal)) {
            return true;
        }

        $last_exec_time = (int)explode('__', basename($journal))[0];

        return (time() - $last_exec_time) > $interval;
    }

    public static function attach_js($buffer)
    {
        $is_ajax = isset($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest';
        $is_html = preg_match('/^\s*(<!doctype|<!DOCTYPE|<html)/i', $buffer) == 1;

        if (!$is_ajax && $is_html) {
            $path = __DIR__ . DIRECTORY_SEPARATOR . 'assets' . DIRECTORY_SEPARATOR . 'fswatcher.js';
            $addition =
                '<script type="text/javascript">var fswatcherToken = "' . md5(filemtime(__FILE__)) . '";</script>'
                . '<script type="text/javascript">' . file_get_contents($path) . '</script>';

            $buffer = preg_replace(
                '/<\/body>(\s|<.*>)*<\/html>\s*$/i',
                $addition.'</body></html>',
                $buffer,
                1
            );
        }

        return $buffer;
    }

    public static function isRC()
    {
        Logger::log([
            'isRC',
            isset($_POST['fswatcher_token']) ? $_POST['fswatcher_token'] : 'no token',
            md5(filemtime(__FILE__)),

        ]);
        if (isset($_POST['fswatcher_token']) && $_POST['fswatcher_token'] == md5(filemtime(__FILE__))) {
            return true;
        }

        return false;
    }
}