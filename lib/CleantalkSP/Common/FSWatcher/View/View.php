<?php

namespace CleantalkSP\Common\FSWatcher\View;

use CleantalkSP\Common\FSWatcher\Controller;
use CleantalkSP\Common\FSWatcher\Logger;

class View
{
    public static function getFSWatcherDescription()
    {
        $description = __('This feature runs filesystem snapshots every ', 'security-malware-firewall');
        $description .= Controller::EXECUTION_MIN_INTERVAL;
        $description .= __(' seconds and allows you to control which of your site files has been changed between selected dates.', 'security-malware-firewall');
        return $description;
    }

    public static function renderSelectors()
    {
        $html = '<div class="spbc_tab_fields_group">';
        $html .= '<div class="spbc_group_header">';
        $html .= '<h3>File System Journal</h3>';
        $html .= '</div>';

        $html .= '<div style="padding: 0 0 0 10px">';
        $html .= '<p>' . self::getFSWatcherDescription() . '</p>';
        $html .= '<p>' . __('To run comparison select dates which you want to compare and click the "Compare" button.', 'security-malware-firewall') . '</p>';
        $html .= '<label style="display: block" for="fswatcher__first_date">First date</label>';
        $html .= '<select name="fswatcher__first_date" id="fswatcher__first_date">';
        $html .= self::renderSelectorOptions();
        $html .= '</select>';
        $html .= '</br>';
        $html .= '</br>';


        $html .= '<label style="display: block" for="fswatcher__second_date">Second date</label>';
        $html .= '<select name="fswatcher__second_date" id="fswatcher__second_date">';
        $html .= self::renderSelectorOptions();
        $html .= '</select>';
        $html .= '</br>';
        $html .= '</br>';

        $html .= '<div>';
        $html .= '<button class="spbc-icon-exchange" id="fswatcher__compare" onclick="return false;">Compare</button>';
        $html .= '</div>';
        $html .= '</br>';

        $html .= '</div>';

        $html .= '<script type="text/javascript">';
        $path = __DIR__ . DIRECTORY_SEPARATOR . '..' . DIRECTORY_SEPARATOR . 'Service.php';
        $html .= 'var fswatcherToken = "' . md5((string)filemtime($path)) . '";';
        $html .= file_get_contents(__DIR__ . '/../assets/fswatcher-compare.js');
        $html .= '</script>';
        $html .= '</div>';

        $html .= '</br>';

        $html .= self::renderTableTemplate();

        return $html;
    }

    private static function renderSelectorOptions()
    {
        $dates = Controller::$repository::getAvailableJournals();

        Logger::log($dates);

        $html = '';
        foreach ($dates as $date) {
            $formated_date = date('Y-m-d H:i:s', $date);
            $html .= '<option value="' . $date . '">' . $formated_date . '</option>';
        }

        return $html;
    }

    private static function renderTableTemplate()
    {
        $html = '<div class="ui-accordion" id="spbc--fs-watcher-table-div">';
        $html .= '<p class="spbc_short_text_field" id="spbc--fs-watcher-table-handling-selects-info" style="display: none"></p>';
        $html .= '<table class="wp-list-table widefat fixed striped">';

        $html .= '<thead>';
        $html .=    '<tr>';
        $html .=        '<th>';
        $html .=        'Path';
        $html .=        '</th>';
        $html .=        '<th>';
        $html .=        'Event';
        $html .=        '</th>';
        $html .=        '<th>';
        $html .=        'Changed on date';
        $html .=        '</th>';
        $html .=    '</tr>';
        $html .= '</thead>';

        $html .= '<tbody id="spbc-table-fs_watcher-comparison">';
        $html .=    '<tr id="spbc-tr-default-comparison-result">';
        $html .=        '<td colspan="3">';
        $html .=        'No logs compared yet.';
        $html .=        '</td>';
        $html .=    '</tr>';
        $html .= '</tbody>';

        $html .= '</table>';
        $html .= '</div>';

        return $html;
    }
}
