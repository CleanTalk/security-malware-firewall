<?php

namespace CleantalkSP\Common\FSWatcher\Scan;

use CleantalkSP\Common\FSWatcher\Logger;
use CleantalkSP\Common\FSWatcher\Repository\Repository;

class Scan
{
    const debug = true;

    public static $dir_to_watch = '';
    public static $exclude_dirs = array();
    public static $extensions_to_watch = array('php');

    public static function run()
    {
        $journal = Repository::makeProcessingJournal();
        if (self::debug) {
            Logger::log('create processing journal ' . $journal);
        }
        self::scan($journal);
    }

    public static function setParams($params)
    {
        self::$dir_to_watch = $params['dir_to_watch'];
        self::$exclude_dirs = $params['exclude_dirs'];
        self::$extensions_to_watch = $params['extensions_to_watch'];
    }

    private static function scan($journal)
    {
        $iterator = new \RecursiveIteratorIterator(
            new \RecursiveDirectoryIterator(self::$dir_to_watch, \RecursiveDirectoryIterator::SKIP_DOTS),
            \RecursiveIteratorIterator::SELF_FIRST,
            \RecursiveIteratorIterator::CATCH_GET_CHILD
        );

        $fp = fopen($journal, 'w');
        foreach ($iterator as $path => $dir) {
            if ($dir->isDir() && !in_array($dir->getFilename(), self::$exclude_dirs)) {
                $iterator->next();
            } else {
                if (in_array($dir->getExtension(), self::$extensions_to_watch)) {
                    fputcsv($fp, [$path]);
                }
            }
        }
        fclose($fp);
    }
}