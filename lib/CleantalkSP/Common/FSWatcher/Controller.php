<?php

namespace CleantalkSP\Common\FSWatcher;

use CleantalkSP\Common\FSWatcher\Repository\Repository;
use CleantalkSP\Common\FSWatcher\Scan\Scan;

class Controller
{
    const debug = true;

    const STATUS_STOPPED = 'stopped';
    const STATUS_RUNNING = 'running';

    const EXECUTION_MIN_INTERVAL = 60;

    private static $status = self::STATUS_STOPPED;

    public static function work($params)
    {
        if (self::debug) {
            Logger::log('check remote call = ' . Service::isRC());
        }

        if (self::status() === self::STATUS_STOPPED && Service::isRC()) {
            Scan::setParams($params);
            self::run();

            die('OK');
        }

        if (self::status() === self::STATUS_STOPPED && Service::isMinIntervalPassed(self::EXECUTION_MIN_INTERVAL)) {
            if (self::debug) {
                Logger::log('attach js to make request');
            }
            ob_start(['CleantalkSP\Common\FSWatcher\Service', 'attach_js']);
        }
    }

    public static function run()
    {
        self::$status = self::STATUS_RUNNING;
        Scan::run();
    }

    public static function stop()
    {
        self::$status = self::STATUS_STOPPED;
    }

    public static function status()
    {
        $is_exist = Repository::getProcessingJournal();
        if (!is_null($is_exist)) {
            self::$status = self::STATUS_RUNNING;
        }

        return self::$status;
    }
}