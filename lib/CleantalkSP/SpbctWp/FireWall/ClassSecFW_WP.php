<?php
/*
 * FireWall module: Security FireWall.
 * Compatible with WordPress only.
 *
 * @version       1.0
 * @author        Cleantalk team (welcome@cleantalk.org)
 * @copyright (C) 2014 CleanTalk team (http://cleantalk.org)
 * @license       GNU/GPL: http://www.gnu.org/copyleft/gpl.html
 * @since 2.49
 */

namespace CleantalkSP\SpbctWp\FireWall;


use CleantalkSP\SpbctWp\Helper;

class ClassSecFW_WP extends FireWall_module_fw {

	/**
	 * Check every IP using FireWall data table.
	 *
	 * @return array
	 */
	public function check() {

		global $wpdb;

		$results = array();

		foreach( $this->ip_array as $ip_origin => $current_ip ) {

			$ip_type = Helper::ip__validate($current_ip);

			// IPv4 query
			if( $ip_type && $ip_type == 'v4' ){

				$current_ip_v4 = sprintf( "%u", ip2long( $current_ip ) );
				for ( $needles = array(), $m = 6; $m <= 32; $m ++ ) {
					$mask      = str_repeat( '1', $m );
					$mask      = str_pad( $mask, 32, '0' );
					$needles[] = sprintf( "%u", bindec( $mask & base_convert( $current_ip_v4, 10, 2 ) ) );
				}
				$needles = array_unique( $needles );

				$query = '(
					SELECT 0 AS is_personal, 1 AS is_ip, status, country_code
					FROM ' . SPBC_TBL_FIREWALL_DATA . '
					WHERE
						network IN (' . implode( ',', $needles ) . ')
						AND network = ' . $current_ip_v4 . ' & mask
						AND country_code = "0"
				) UNION (
					SELECT 1 AS is_personal, 1 AS is_ip, status, 0 AS country_code
					FROM ' . SPBC_TBL_FIREWALL_DATA__IPS . '
					WHERE
						network IN (' . implode( ',', $needles ) . ')
						AND network = ' . $current_ip_v4 . ' & mask
				) UNION (
					SELECT 1 AS is_personal, 0 AS is_ip, tbl_private.status, country_code
					FROM ' . SPBC_TBL_FIREWALL_DATA__COUNTRIES . ' AS tbl_private
					RIGHT JOIN wp_spbc_firewall_data AS tbl_common USING(country_code)
					WHERE
						network IN (' . implode( ',', $needles ) . ')
						AND network = ' . $current_ip_v4 . ' & mask
				)';

				$result = $wpdb->get_results( $query, ARRAY_A );

			}

			// In base
			if( ! empty( $result ) ) {

				foreach( $result as $entry ) {
					switch ( $entry['status'] ) {
						case 2:	 $results[] = array('ip' => $current_ip, 'is_personal' => (bool)$entry['is_personal'], 'status' => 'PASS_BY_TRUSTED_NETWORK',); break;
						case 1:	 $results[] = array('ip' => $current_ip, 'is_personal' => (bool)$entry['is_personal'], 'status' => 'PASS_BY_WHITELIST',);       break;
						case 0:	 $results[] = array('ip' => $current_ip, 'is_personal' => (bool)$entry['is_personal'], 'status' => 'DENY',);                    break;
						case -1: $results[] = array('ip' => $current_ip, 'is_personal' => (bool)$entry['is_personal'], 'status' => 'DENY_BY_NETWORK',);         break;
						case -2: $results[] = array('ip' => $current_ip, 'is_personal' => (bool)$entry['is_personal'], 'status' => 'DENY_BY_DOS',);             break;
					}
				}

			// Not in base
			}else {

				$results[] = array( 'ip' => $current_ip, 'is_personal' => false, 'status' => 'PASS' );

			}

		}

		return $results;

	}

}