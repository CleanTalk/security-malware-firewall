<?php

namespace CleantalkSP\Security;

/**
 * Class ScannerFrontend_scanContent
 *
 * Scan any content for frontend malware (HTML, JS)
 *
 * @version       1.1.0
 * @package       Security by Cleantalk
 * @category      ScannerFrontend
 * @author        Cleantalk team (welcome@cleantalk.org)
 * @copyright (C) 2014 CleanTalk team (http://cleantalk.org)
 * @license       GNU/GPL: http://www.gnu.org/copyleft/gpl.html
 * @link          https://github.com/CleanTalk/php-antispam
 */
class ScannerFrontend_scanContent {
	
	/**
	 * Given conten to check
	 * @var string
	 */
	private $content;
	/**
	 * DOMDocument created from content
	 * @var \DOMDocument
	 */
	private $dom;
	/**
	 * URL that consider as home URL. All links with this host consider as harmful
	 * @var string
	 */
	private $home_url;
	
	
	/**
	 * Signatures with HTML code
	 * @var array
	 */
	private $signatures_html;
	/**
	 * Signatures with JS code
	 * @var array
	 */
	private $signatures_js;
	
	/*
	 * Flags for scan type
	 */
	private $scan_for_redirect   = false;
	private $scan_for_dbd        = false;
	private $scan_for_signatures = false;
	
	/**
	 * Results of a scan
	 * @var array
	 */
	private $result = array();
	
	/**
	 * Constructor
	 *
	 * @param string $home_url
	 * @param array $signatures
	 * @param array $check_list
	 */
	function __construct( $home_url = '', $signatures = array(), $check_list = array('redirects', 'dbd', 'signatures') )
	{
		$this->home_url = $home_url;
		
		$this->scan_for_redirect   = in_array( 'redirects',  $check_list ) && $home_url;
		$this->scan_for_dbd        = in_array( 'dbd',        $check_list ) && $home_url;
		$this->scan_for_signatures = in_array( 'signatures', $check_list ) && $signatures;
		
		// Spplit signatures in two groups
		foreach( $signatures as $signature ){
			
			if( $signature['type'] === 'CODE_HTML' )
				$this->signatures_html[] = $signature;
			
			if( $signature['type'] === 'CODE_JS' )
				$this->signatures_js[] = $signature;
			
		}
	}
	
	/**
	 * Method which gathering all check types
	 *
	 * Liquid interface
	 *
	 * @return ScannerFrontend_scanContent
	 */
	public function check(){
		
		$this->result = array_merge(
			$this->scan_for_redirect ? $this->check__for_redirects()        : array(),
			$this->scan_for_dbd      ? $this->check__for_driveByDownload()  : array(),
			$this->scan_for_signatures   ? $this->check__for_signatures__js()   : array(),
			$this->scan_for_signatures      ? $this->check__for_signatures__html() : array()
		);
		
		return $this;
	}
	
	/**
	 * Check given DOMDocument for redirects
	 *
	 * @return array
	 */
	private function check__for_redirects(){
		
		// Getting JS tags to check
		$xpath = new \DOMXPath( $this->dom );
		$js    = $xpath->evaluate( "/html//script" );
		
		$home_url = parse_url( $this->home_url, PHP_URL_HOST );
		$home_url = str_replace( '.', '\.', $home_url );
		
		$results = $this->check__for_anything(
			$js,
			'/location(?:\s*\.\s*href\s*)?\s*=\s*["\'](?:http[s]?:\/\/)(?:www\.)?(?!'.$home_url.').*/',
			'regexp'
		);
		
		foreach ( $results as $result ){
			$out[] = array(
				'type'           => 'redirects',
				'line'           => $result['haystack_original'] instanceof \DOMElement
					? $result['haystack_original']->getLineNo()
					: 0,
				'found'          => htmlentities( $result['found'] ),
				'found_extended' => htmlentities( substr(
					$result['haystack'],
					strpos( $result['haystack'], $result['found'] ) - 40 > 0
						? strpos( $result['haystack'], $result['found'] ) - 40
						: 0,
					strlen( $result['found'] ) + 80
				)),
				'needle'        => $result['needle'],
			);
		}
		
		return isset( $out ) ? $out : array();
	}
	
	/**
	 * Check given DOMDocument for drive by download attack
	 *
	 * @return array
	 */
	private function check__for_driveByDownload(){
		
		// Getting JS tags to check
		$xpath   = new \DOMXPath( $this->dom );
		$iframes = $xpath->evaluate( "/html//iframe" );
		
		$home_url = parse_url( $this->home_url, PHP_URL_HOST );
		$home_url = str_replace( '.', '\.', $home_url );
		
		$results = array();
		foreach($iframes as $iframe){
			$results = array_merge(
				$results,
				$this->check__for_anything(
					$iframe,
					'/^http[s]?:\/\/(wwww)?(?!'.$home_url.').*/',
					'regexp'
				)
			);
		}
		
		foreach ( $results as $result ){
			
			$out[] = array(
				'type'           => 'dbd',
				'line'           => $result['haystack_original'] instanceof \DOMElement
					? $result['haystack_original']->getLineNo()
					: 0,
				'found'          => htmlentities( $result['found'] ),
				'found_extended' => htmlentities( substr(
					$this->content,
					strpos( $this->content, $result['found'] ) - 40 > 0
						? strpos( $this->content, $result['found'] ) - 40
						: 0,
					strlen( $result['found'] ) + 80
				)),
				'needle'        => $result['needle'],
			);
		}
		
		return isset( $out ) ? $out : array();
		
	}
	
	/**
	 * Check given DOMDocument for JS signatures
	 *
	 * @return array
	 */
	private function check__for_signatures__js(){
		
		// Getting JS tags to check
		$xpath = new \DOMXPath($this->dom);
		$js = $xpath->evaluate("/html//script");
		
		$results = $this->check__for_anything(
			$js,
			$this->signatures_js
		);
		
		foreach ( $results as $result ){
			$out[] = array(
				'type'           => 'signatures',
				'line'           => $result['haystack_original'] instanceof \DOMElement
					? $result['haystack_original']->getLineNo()
					: 0,
				'found'          => htmlentities( $result['found'] ),
				'found_extended' => htmlentities( substr(
					$result['haystack'],
					strpos( $result['haystack'], $result['found'] ) - 40 > 0
						? strpos( $result['haystack'], $result['found'] ) - 40
						: 0,
					strlen( $result['found'] ) + 80
				)),
				'needle'        => $result['needle'],
				'signature'     => $result['signature'],
			);
		}
		
		return isset( $out ) ? $out : array();
	}
	
	/**
	 * * Check given content for HTML signatures
	 *
	 * @return array
	 */
	private function check__for_signatures__html(){
		
		$results = $this->check__for_anything(
			$this->content,
			$this->signatures_html
		);
		
		foreach ( $results as $result ){
			$out[] = array(
				'type'           => 'signatures',
				'line'           => $result['haystack_original'] instanceof \DOMElement
					? $result['haystack_original']->getLineNo()
					: 0,
				'found'          => htmlentities( $result['found'] ),
				'found_extended' => htmlentities( substr(
					$result['haystack'],
					strpos( $result['haystack'], $result['found'] ) - 40 > 0
						? strpos( $result['haystack'], $result['found'] ) - 40
						: 0,
					strlen( $result['found'] ) + 80
				)),
				'needle'        => $result['needle'],
				'signature'     => $result['signature'],
			);
		}
		
		return isset( $out ) ? $out : array();
	}
	
	/**
	 * Universal method to check any type of threat
	 *
	 * @param array|string|\DOMElement $haystacks
	 * @param array|string $needles
	 * @param string $search_type
	 *
	 * @return array
	 */
	private function check__for_anything( $haystacks, $needles, $search_type = 'string' ){
		
		$haystacks = is_string($haystacks) ? array($haystacks) : $haystacks;
		$needles   = is_string($needles)   ? array($needles)   : $needles;
		
		if( $haystacks instanceof \DOMElement && $haystacks->tagName === 'iframe'){
			$iframe = $haystacks;
			$haystacks = array(
				$iframe->getAttribute('src'),
				$iframe->getAttribute('data-src'),
				$iframe->getAttribute('data-frame-src'),
			);
		}
		
		foreach($haystacks as $key => $haystack){
			
			// Getting text value for haystack
			$haystack = $haystack instanceof \DOMElement
				? $haystack->nodeValue
				: $haystack;
			
			foreach($needles as $needle){
				
				$signature = null;
				// If $needle is a signature
				if( is_array( $needle ) ){
					
					$signature = $needle;
					
					// Getting type of search needle
					$search_type = ! empty( $needle['is_regexp'] )
						? 'regexp'
						: $search_type;
					
					// Gettin the body
					$needle =  $needle['body'];
					
				}
				
				switch($search_type){
					
					// Check with strings
					case 'string':
						$pos = strpos($haystack, $needle);
						if($pos !== false){
							$out[] = array(
								'haystack_original' => isset( $iframe ) ? $iframe : $haystacks[$key],
								'haystack'  => $haystack,
								'found'     => substr( $haystack, $pos, strlen( $needle ) ),
								'signature' => $signature,
							);
						}
						break;
					
					// Check with regular expression
					case 'regexp':
						if(preg_match($needle, $haystack, $matches)){
							$out[] = array(
								'haystack_original' => isset( $iframe ) ? $iframe : $haystacks[$key],
								'haystack'  => $haystack,
								'found'     => $matches[0],
								'signature' => $signature,
							);
						}
						break;
				}
			}
		}
		
		return isset( $out ) ? $out : array();
	}
	
	/**
	 * Get $this->result
	 *
	 * @return array
	 */
	public function getResult() {
		return $this->result;
	}
	
	/**
	 * Set $this->content and it's derivatives
	 *
	 * @param string $content
	 *
	 * @return ScannerFrontend_scanContent
	 */
	public function setContent( $content = '' ) {
		$this->content = $content;
		
		$this->dom = new \DOMDocument();
		@$this->dom->loadHTML( $this->content );
		
		return $this;
	}
	
}