<?php

namespace CleantalkSP\SpbctWP\VulnerabilityAlarm;

use CleantalkSP\SpbctWP\VulnerabilityAlarm\Dto\PluginReport;

class VulnerabilityAlarmView
{
    const ASSETS_URL = SPBC_PATH . '/lib/CleantalkSP/SpbctWP/VulnerabilityAlarm/Assets';

    /**
     * @param string $plugin_file
     * @param PluginReport $plugin_report
     *
     * @return string
     */
    public static function showPluginAlarm($plugin_file, $plugin_report)
    {
        $active = is_plugin_active($plugin_file) ? 'active' : 'inactive';
        $slug = $plugin_report->slug;
        $id = $plugin_report->id;
        $alarm_text = esc_html__('This version contains a known vulnerability', 'security-malware-firewall');
        $alarm_cve_url = $plugin_report->CVE;
        $delete_text = esc_html__('It is strongly recommended to delete the plugin.', 'security-malware-firewall');
        $update_text = esc_html__('Updating the plugin to a version higher than ', 'security-malware-firewall');

        $vulnerability_text = sprintf(
            $alarm_text . ' ' . $alarm_cve_url . '. %s',
            ! empty($plugin_report->rs_app_version_max)
                ? $update_text . $plugin_report->rs_app_version_max . ' is strongly recommended.'
                : $delete_text
        );

        $layout_file = __DIR__ . '/View/PluginListAlarmLayout.html';

        if ( file_exists($layout_file) ) {
            $replaces = [
                '{{SLUG}}' => esc_attr($slug),
                '{{ACTIVE}}' => esc_attr($active),
                '{{PLUGIN_FILE}}' => esc_attr($plugin_file),
                '{{VULNERABILITY_TEXT}}' => wp_kses($vulnerability_text, 'post'),
                '{{MORE_DETAILS_LINK}}' => static::getMoreDetailsLink($slug, $id)
            ];
            $layout = file_get_contents($layout_file);

            foreach ($replaces as $place_holder => $replace) {
                $layout = str_replace($place_holder, $replace, $layout);
            }

            return $layout;
        }

        return '<tr><td colspan="4">' . $vulnerability_text . '</td></tr>';
    }

    public static function showThemeAlarm()
    {
        $alarm_text = esc_html__('The theme contains known vulnerability', 'security-malware-firewall');
        return $alarm_text;
    }

    public static function showSafeBadge($module_type, $plugin_slug, $plugin_id)
    {
        $badge_text = esc_html__('Plugin is safe', 'security-malware-firewall');
        if ($module_type === 'theme') {
            $badge_text = esc_html__('Theme is safe', 'security-malware-firewall');
        }
        $badge_description = esc_html__('CleanTalk Security team has been checked this module', 'security-malware-firewall');

        $layout_file = __DIR__ . '/View/PluginIsSafeBadge.html';

        if ( file_exists($layout_file) ) {
            $replaces = [
                '{{ASSETS_URL}}' => self::ASSETS_URL,
                '{{DESCRIPTION}}' => $badge_description,
                '{{MORE_DETAILS_LINK}}' => static::getMoreDetailsLink($plugin_slug, $plugin_id, true)
            ];
            $layout = file_get_contents($layout_file);

            foreach ($replaces as $place_holder => $replace) {
                $layout = str_replace($place_holder, $replace, $layout);
            }

            return $layout;
        }

        return $badge_text;
    }

    /**
     * @param string $plugin_slug
     * @param string $plugin_id
     *
     * @return string
     */
    private static function getMoreDetailsLink($plugin_slug = '', $plugin_id = '', $line_break = false)
    {
        $details_link = "https://research.cleantalk.org";
        $line_break_layout = $line_break ? '<br>' : ' ';
        if ($plugin_slug && $plugin_id) {
            $details_link = esc_attr($details_link . '/reports/app/' . $plugin_slug . '#' . $plugin_id);
        }
        return sprintf(
            esc_html__('Full report is %shere%s', 'security-malware-firewall'),
            '<a href="' . $details_link . '" target="_blank">',
            '</a>'
        )
        . $line_break_layout
        . sprintf(
            esc_html__('Have questions? Ask us %shere%s', 'security-malware-firewall'),
            '<a href="https://wordpress.org/support/plugin/security-malware-firewall/" target="_blank">',
            '</a>'
        );
    }

    /**
     * @psalm-suppress PossiblyUnusedMethod
     * @todo replace the suppressing above
     */
    public static function renderTab()
    {
        global $spbc;

        $layout_file = __DIR__ . '/View/VulnerabilityAlarmTab.html';
        $layout_item_file = __DIR__ . '/View/VulnerabilityAlarmTabItem.html';

        if ( file_exists($layout_file) && file_exists($layout_item_file) ) {

            $replaces = [
                '{{VULNERABILITY_TAB_HEADER}}' => __('Critical updates', 'security-malware-firewall'),
                '{{VULNERABILITY_PLUGINS_TITLE}}' => __('Plugins vulnerabilities', 'security-malware-firewall'),
                '{{VULNERABILITY_PLUGINS_SUBTITLE}}' =>
                    count($spbc->scan_plugins_info['names_vulnerable_plugins']) > 0
                        ? __('Plugins names: ', 'security-malware-firewall')
                        : __('No vulnerabilities found', 'security-malware-firewall'),
                '{{VULNERABILITY_THEMES_TITLE}}' => __('Themes vulnerabilities', 'security-malware-firewall'),
                '{{VULNERABILITY_THEMES_SUBTITLE}}' =>
                    count($spbc->scan_themes_info['names_vulnerable_themes']) > 0
                        ? __('Themes names: ', 'security-malware-firewall')
                        : __('No vulnerabilities found', 'security-malware-firewall')
            ];

            $layout = file_get_contents($layout_file);
            $item_layout = file_get_contents($layout_item_file);

            foreach ($replaces as $place_holder => $replace) {
                $layout = str_replace($place_holder, $replace, $layout);
            }

            $plugin_items_layout = $theme_items_layout = '';

            if ( count($spbc->scan_plugins_info['names_vulnerable_plugins']) > 0 ) {
                /** @var PluginReport $plugin_report */
                foreach ( $spbc->scan_plugins_info['names_vulnerable_plugins'] as $plugin_report ) {
                    $plugin_item_replaces = [
                        '{{VULNERABLE_NAME}}' => $plugin_report->app_name ?: $plugin_report->slug,
                        '{{VULNERABLE_ALERT}}' => self::showPluginAlarm('', $plugin_report),
                    ];
                    $plugin_items_layout .= str_replace(array_keys($plugin_item_replaces), array_values($plugin_item_replaces), $item_layout);
                }
            }

            if ( count($spbc->scan_themes_info['names_vulnerable_themes']) > 0 ) {
                /** @var PluginReport $plugin_report */
                foreach ( $spbc->scan_themes_info['names_vulnerable_themes'] as $theme_report ) {
                    error_log(var_export($theme_report, true));
                    $theme_item_replaces = [
                        '{{VULNERABLE_NAME}}' => $theme_report->app_name ?: $theme_report->slug,
                        '{{VULNERABLE_ALERT}}' => '<div class="notice inline notice-error notice-alt">' . self::showThemeAlarm() . '</div>',
                    ];
                    $theme_items_layout .= str_replace(array_keys($theme_item_replaces), array_values($theme_item_replaces), $item_layout);
                }
            }

            $layout = str_replace('{{PLUGINS_ITEMS}}', $plugin_items_layout, $layout);
            $layout = str_replace('{{THEMES_ITEMS}}', $theme_items_layout, $layout);

            return $layout;
        }

        return '';
    }
}
