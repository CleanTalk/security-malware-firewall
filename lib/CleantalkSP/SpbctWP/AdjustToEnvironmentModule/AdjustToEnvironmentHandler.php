<?php

namespace CleantalkSP\SpbctWP\AdjustToEnvironmentModule;

use CleantalkSP\SpbctWP\AdjustToEnvironmentModule\AdjustToEnv\AdjustToEnvW3TotalCache;
use CleantalkSP\SpbctWP\AdjustToEnvironmentModule\Exceptions\ExceptionReverseAdjustClassNotExists;

class AdjustToEnvironmentHandler
{
    /**
     * Option name to store info what we changed
     */
    const option_name = 'spbc_adjust_to_env';

    /**
     * Set of adjust classes
     * @var array
     */
    const set_of_adjust = [
        'w3tc' => AdjustToEnvW3TotalCache::class,
    ];

    /**
     * Info what we changed
     * @var array
     */
    private $info;

    /**
     * Constructor
     */
    public function __construct()
    {
        $this->info = self::getInfoWhatWeChanged();
    }

    /**
     * Run
     * @return void
     */
    public function handle()
    {
        foreach ( array_values(self::set_of_adjust) as $adjust_class ) {
            $adjust = new $adjust_class($this->info);
            $adjust->run();
            $this->info = $adjust->getUpdatedInfo();
        }

        $this->saveInfoWhatWeChanged();
    }

    /**
     * Run one adjust
     * @param string $class
     * @return void
     */
    public function handleOne($class)
    {
        if (!class_exists($class)) {
            throw new ExceptionReverseAdjustClassNotExists();
        }

        $adjust = new $class($this->info);
        $adjust->runOne();
        $this->info = $adjust->getUpdatedInfo();

        $this->saveInfoWhatWeChanged();
    }

    /**
     * Reverse the adjustments made by the adjust() method
     * @param string $class
     * @return void
     * @throws Exception
     */
    public function reverseAdjust($class)
    {
        if (!class_exists($class)) {
            throw new ExceptionReverseAdjustClassNotExists();
        }

        $adjust = new $class($this->info);
        $adjust->reverseAdjust();
        $this->info = $adjust->getUpdatedInfo();

        $this->saveInfoWhatWeChanged();
    }

    /**
     * Get info what we changed
     * @return array
     */
    public static function getInfoWhatWeChanged()
    {
        return get_option(self::option_name, []);
    }

    /**
     * Save info what we changed
     * @return void
     */
    private function saveInfoWhatWeChanged()
    {
        update_option(self::option_name, $this->info);
    }
}
