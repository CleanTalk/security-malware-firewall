<?php

namespace CleantalkSP\SpbctWP\ScanResultsLogModule;

use CleantalkSP\SpbctWP\DB;

class ScanResultsLogRepository
{
    /**
     * @var DB
     */
    private $db;

    /**
     * Count per page
     * @type int
     */
    public $count_per_page = 20;

    public function __construct()
    {
        $this->db = DB::getInstance();
    }

    /**
     * Inset or update table
     */
    public function addScanResultsLogRow($fast_hash, $check_type, $status_of_check)
    {
        $this->db->prepare(
            'INSERT INTO ' . SPBC_TBL_SCAN_RESULTS_LOG
            . ' (fast_hash, check_type, status_of_check, checked_at) VALUES'
            . " (%s, %s, %s, %d) "
            . 'ON DUPLICATE KEY UPDATE
                    status_of_check = VALUES(`status_of_check`),
                    checked_at = VALUES(`checked_at`)',
            array($fast_hash, $check_type, $status_of_check, time())
        )->execute();
    }

    /**
     * Get rows default
     */
    public function getScanResultsLogRows()
    {
        $rows = $this->db->fetchAll(
            'SELECT r.path, l.check_type, l.status_of_check, l.checked_at
            FROM ' . SPBC_TBL_SCAN_RESULTS_LOG . ' AS l
            INNER JOIN ' . SPBC_TBL_SCAN_FILES . ' AS r
            ON l.fast_hash = r.fast_hash
            LIMIT ' . $this->count_per_page
        );

        return $rows;
    }

    /**
     * Get rows with pagination by params
     */
    public function getScanResultsLogRowsByParams(
        $search_string,
        $search_status = 'all',
        $search_type = 'all',
        $search_offset = 0)
    {
        $where_status = '';
        $where_type = '';
        $offset = ' OFFSET ' . $search_offset;

        if ($search_status !== 'all') {
            $where_status  = " AND l.status_of_check='$search_status'";
        }
        if ($search_type !== 'all') {
            $where_status  = " AND l.check_type='$search_type'";
        }

        $rows = $this->db->fetchAll("
            SELECT r.path, l.check_type, l.status_of_check, l.checked_at
            FROM " . SPBC_TBL_SCAN_RESULTS_LOG . " AS l
            INNER JOIN " . SPBC_TBL_SCAN_FILES . " AS r
            ON l.fast_hash = r.fast_hash
            WHERE r.path LIKE '%$search_string%'
            " . $where_status . "
            " . $where_type . "
            ORDER BY l.checked_at
            LIMIT " . $this->count_per_page . $offset);

        return $rows;
    }
}