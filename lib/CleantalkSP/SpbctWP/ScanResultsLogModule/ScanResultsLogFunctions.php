<?php

namespace CleantalkSP\SpbctWP\ScanResultsLogModule;

use CleantalkSP\Variables\Post;

class ScanResultsLogFunctions
{
    public static function getLogByParams()
    {
        spbc_check_ajax_referer('spbc_secret_nonce', 'security');

        $search_string = Post::get('searchString');
        $search_status = Post::get('searchStatus');
        $search_type = Post::get('searchType');
        $search_offset = Post::get('searchOffset');

        $scan_results_log_repository = new ScanResultsLogRepository();
        $rows = $scan_results_log_repository->getScanResultsLogRowsByParams(
            $search_string,
            $search_status,
            $search_type,
            $search_offset
        );

        if (count($rows) > 0) {
            $template = '';

            foreach ($rows as $row) {
                $template .= '<p class="spbc_log-line">'
                             . gmdate('Y-m-d H:i:s', $row['checked_at'])
                             . ' - ' .$row['path'] .
                             '<b>: ' . $row['status_of_check'] . '</b>' .
                             '<i>: ' . strtolower($row['check_type']) . '</i>' .
                             '</p>';
            }

            echo $template;
        } else {
            wp_die(__('Sorry, not founded', 'security-malware-firewall'));
        }

        die;
    }
}