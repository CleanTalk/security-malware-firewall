<?php

namespace CleantalkSP\SpbctWP\Scanner\FileMonitoringModule;

class FileMonitoringRepository
{
    public static function saveFileIfNew(File $file)
    {
        global $wpdb;

        $exists_file = self::getFileByPathHash($file->path_hash);

        if (is_null($exists_file)) {
            $wpdb->insert(
                SPBC_TBL_IMPORTANT_FILES,
                array(
                    'path' => $file->path,
                    'path_hash' => $file->path_hash,
                    'started_at' => $file->started_at
                ),
                array(
                    '%s', '%s', '%d'
                )
            );

            $file->id = $wpdb->insert_id;
        } else {
            $file->id = $exists_file->id;
        }
    }

    public static function saveNewSnapshot(File $file)
    {
        global $wpdb;

        $exists_snapshot = self::getSnapshotByHash($file);

        if (is_null($exists_snapshot)) {
            $file_id = $file->id;
            $content = file_exists($file->path) ? file_get_contents($file->path) : null;
            $content_hash = $file->content_hash;
            $created_at = time();

            $wpdb->insert(
                SPBC_TBL_IMPORTANT_FILES_SNAPSHOTS,
                array(
                    'file_id' => $file_id,
                    'content' => $content,
                    'content_hash' => $content_hash,
                    'created_at' => $created_at
                ),
                array(
                    '%d', '%s', '%s', '%d'
                )
            );
        }
    }

    public static function getFileByPathHash($path_hash)
    {
        global $wpdb;

        return $wpdb->get_row(
            "SELECT * FROM "
            . SPBC_TBL_IMPORTANT_FILES
            . " WHERE path_hash = '" . $path_hash . "'"
        );
    }

    public static function getSnapshotByHash(File $file)
    {
        global $wpdb;

        return $wpdb->get_row(
            "SELECT * FROM "
            . SPBC_TBL_IMPORTANT_FILES_SNAPSHOTS
            . " WHERE content_hash = '" . $file->content_hash . "' AND file_id = " . $file->id
        );
    }

    public static function getFilePathsFromDb()
    {
        global $wpdb;

        $prepared_file_array = array();
        $files = $wpdb->get_results(
            "SELECT path FROM " . SPBC_TBL_IMPORTANT_FILES,
            ARRAY_A
        );

        foreach ($files as $file) {
            $prepared_file_array[] = str_replace(rtrim(ABSPATH, '/'), '', $file['path']);
        }

        return $prepared_file_array;
    }

    public static function getCountFilesInDb()
    {
        global $wpdb;

        return $wpdb->get_var( "SELECT COUNT(*) FROM " . SPBC_TBL_IMPORTANT_FILES . ";" );
    }
}
