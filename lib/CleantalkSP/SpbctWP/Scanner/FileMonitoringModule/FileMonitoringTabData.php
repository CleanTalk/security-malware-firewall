<?php

namespace CleantalkSP\SpbctWP\Scanner\FileMonitoringModule;

class FileMonitoringTabData
{
    public static function getDataToAccordion()
    {
        $data_to_accordion = array();

        $files = FileMonitoringRepository::getFilesFromDb();

        if ($files) {
            foreach ($files as $file) {
                $data_to_accordion[] = (object) array(
                    'path' => $file['path'],
                    'id' => $file['id'],
                );
            }
        }

        return $data_to_accordion;
    }

    public static function prepareDataToAccordion($table)
    {
        if ($table->items_count) {
            foreach ($table->rows as $row) {
                $table->items[] = array(
                    'path'        => $row->path,
                    'uid'         => $row->id,
                    'actions'     => $row->actions,
                );
            }
        }

        return $table;
    }

    public static function showCurrentSnapshot()
    {
//        if ( ! check_ajax_referer('spbc_secret_nonce', 'security', false) ) {
//            wp_send_json(array('error' => 'Nonce had been changed. Please, restart the scan.'));
//        }
//        $output = array(
//            'success'    => true,
//            'file'       => $file_text,
//            'file_path'  => $file_path,
//            'difference' => $file_info['difference'],
//            'weak_spots' => $file_info['weak_spots']
//        );
//        wp_send_json($output);
    }

    public static function showSnapshots()
    {
        spbc_check_ajax_referer('spbc_secret_nonce', 'security');

        $file_id = isset($_POST['file_id']) ? (int)$_POST['file_id'] : null;

        if (is_null($file_id)) {
            wp_send_json_error(esc_html__('Error: File not founded.', 'security-malware-firewall'));
        }

        $snapshots = FileMonitoringRepository::getSnapshotsByFileId($file_id);

        if (is_null($snapshots)) {
            wp_send_json_error(esc_html__('Error: Snapshots not founded.', 'security-malware-firewall'));
        }

        wp_send_json_success($snapshots);
    }

    public static function getModalTemplate()
    {
        ?>
        <div data-remodal-id="spbc-file-monitoring-modal">
            <button data-remodal-action="close" class="remodal-close"></button>
<!--            <img id="spbc-file-monitoring-modal-preloader" src="--><?php //echo SPBC_PATH; ?><!--/images/preloader2.gif">-->
            <div class="spbc-fm-container">
                <div class="spbc-fm-snapshot-list" id="spbc-fm-snapshot-list">
                    <ul>
                        <li class="active">12.12.12</li>
                        <li>12.12.12</li>
                    </ul>
                </div>
                <div class="spbc-fm-snapshot-view" id="spbc-fm-snapshot-view">
                    some content
                </div>
            </div>
        </div>
        <?php
    }
}