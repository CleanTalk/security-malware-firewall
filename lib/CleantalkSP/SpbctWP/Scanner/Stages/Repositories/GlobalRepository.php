<?php

namespace CleantalkSP\SpbctWP\Scanner\Stages\Repositories;

use CleantalkSP\SpbctWP\DB;

abstract class GlobalRepository
{
    /**
     * @var DB
     */
    protected $db;

    /**
     * @var DB
     */
    protected $spbc;

    public function __construct()
    {
        global $spbc;

        $this->db = DB::getInstance();
        $this->spbc = $spbc;
    }

    abstract protected function isNeedToGet();

    abstract protected function catchResultData();

    public function getResultData()
    {
        $result = [];

        if ($this->isNeedToGet()) {
            $result = $this->catchResultData();
            if (count($result)) {
                $result = $this->prepareResultData($result);
            }
        }

        return $result;
    }

    protected function prepareResultData($data)
    {
        $result = [];

        foreach ($data as $row) {
            $path = $this->spbc->is_windows ? str_replace('\\', '/', $row['path']) : $row['path'];
            $row['mtime'] = $row['mtime'] + $this->spbc->data['site_utc_offset_in_seconds'];
            $result[$path] = array_values($row);
        }

        return $result;
    }
}
