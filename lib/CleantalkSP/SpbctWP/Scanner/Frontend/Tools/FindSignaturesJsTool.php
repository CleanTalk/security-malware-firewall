<?php

namespace CleantalkSP\SpbctWP\Scanner\Frontend\Tools;

use CleantalkSP\SpbctWP\Helpers\Helper;

class FindSignaturesJsTool extends FrontendAnalyzeTool
{
    const TYPE = 'signatures';

    public function analyse()
    {
        $dom = new \DOMDocument();
        $resultDomLoading = $dom->loadHTML($this->page->getContentPage(), LIBXML_NOERROR);

        if ($resultDomLoading === false) {
            // Что то делаем если дом не прогрузился
        }

        $tagScripts = $dom->getElementsByTagName('script');
        foreach ($tagScripts as $script) {
            foreach ($this->config->getSignaturesJs() as $signature) {
                $search_type = Helper::isRegexp($signature['body'])
                    ? 'regexp'
                    : 'string';

                switch ( $search_type ) {
                    // Check with regular expression
                    case 'regexp':
                        if ( preg_match($signature['body'], $script->nodeValue, $matches) ) {
                            $this->config->addResult($this->buildResult(
                                self::TYPE,
                                $script->getLineNo(),
                                $matches[0],
                                $signature['id']
                            ));
                        }
                        break;

                    // Check with strings
                    default:
                        $pos = strpos($script->nodeValue, $signature['body']);
                        if ( $pos !== false ) {
                            $this->config->addResult($this->buildResult(
                                self::TYPE,
                                $script->getLineNo(),
                                $script->nodeValue,
                                $signature['id']
                            ));
                        }
                        break;
                }
            }
        }
    }
}