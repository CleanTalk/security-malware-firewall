<?php

namespace CleantalkSP\SpbctWP\Scanner\Frontend\Tools;

use CleantalkSP\SpbctWP\Helpers\Helper;

class FindSignaturesHtmlTool extends FrontendAnalyzeTool
{
    const TYPE = 'signatures';

    public function analyse()
    {
        foreach ($this->config->getSignaturesHtml() as $signature) {
            $search_type = Helper::isRegexp($signature['body'])
                ? 'regexp'
                : 'string';

            switch ( $search_type ) {
                // Check with regular expression
                case 'regexp':
                    if ( preg_match($signature['body'], $this->page->getContentPage(), $matches) ) {
                        $this->config->addResult($this->buildResult(
                            self::TYPE,
                            null,
                            $matches[0],
                            $signature['id']
                        ));
                    }
                    break;

                // Check with strings
                default:
                    $pos = strpos($this->page->getContentPage(), $signature['body']);
                    if ( $pos !== false ) {
                        $this->config->addResult($this->buildResult(
                            self::TYPE,
                            null,
                            $signature['body'],
                            $signature['id']
                        ));
                    }
                    break;
            }
        }
    }
}