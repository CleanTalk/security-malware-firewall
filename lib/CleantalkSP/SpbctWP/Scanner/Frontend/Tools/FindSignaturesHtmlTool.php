<?php

namespace CleantalkSP\SpbctWP\Scanner\Frontend\Tools;

use CleantalkSP\SpbctWP\Helpers\Helper;

class FindSignaturesHtmlTool extends FrontendTool
{
    const TYPE = 'signatures';

    public function analyse()
    {
        foreach ($this->config->getSignaturesHtml() as $signature) {
            $search_type = Helper::isRegexp($signature['body'])
                ? 'regexp'
                : 'string';

            switch ( $search_type ) {
                // Check with regular expression
                case 'regexp':
                    if ( preg_match($signature['body'], $this->page->getContentPage(), $matches) ) {
                        $this->problemsFound[] = array(
                            'code' => $matches[0],
                            'signature' => $signature['id'],
                        );
                    }
                    break;

                // Check with strings
                default:
                    $pos = strpos($this->page->getContentPage(), $signature['body']);
                    if ( $pos !== false ) {
                        $this->problemsFound[] = array(
                            'type' => self::TYPE,
                            'code' => $signature['body'],
                            'signature' => $signature['id'],
                        );
                    }
                    break;
            }
        }

        return $this->getResult();
    }
}