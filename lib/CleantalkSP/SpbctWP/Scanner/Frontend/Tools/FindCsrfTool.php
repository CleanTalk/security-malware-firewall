<?php

namespace CleantalkSP\SpbctWP\Scanner\Frontend\Tools;

class FindCsrfTool extends FrontendAnalyzeTool
{
    const TYPE = 'csrf';

    public function analyse()
    {
        $params_parts = array('cid', 'uid', 'account', 'user');
        $attributes   = array('src', 'href');

        $dom = new \DOMDocument();
        $dom->loadHTML($this->page->getContentPage(), LIBXML_NOERROR);
        $xpath          = new \DOMXPath($dom);
        $attributesDOM = $xpath->evaluate('//@' . implode('|//@', $attributes));

        foreach ($attributesDOM as $item) {
            if (strpos($item->nodeValue, $this->config->getHomeUrl()) !== false) {
                continue;
            }
            if ( preg_match(
                '/\?.*(' . implode('|', $params_parts) . ')(.*?)=/',
                $item->nodeValue,
                $matches)
            ) {
                $this->config->addResult($this->buildResult(
                    self::TYPE,
                    $item->getLineNo(),
                    $matches[0]
                ));
            }
        }
    }
}