<?php

namespace CleantalkSP\SpbctWP\Scanner\Frontend\Tools;

class FindDriveByDownloadTool extends FrontendAnalyzeTool
{
    const TYPE = 'dbd';
    public function analyse()
    {
        $dom = new \DOMDocument();
        $resultDomLoading = $dom->loadHTML($this->page->getContentPage(), LIBXML_NOERROR);

        if ($resultDomLoading === false) {
            // Что то делаем если дом не прогрузился
        }

        $tagIframes = $dom->getElementsByTagName('iframe');
        foreach ($tagIframes as $iframe) {
            $haystacks = array(
                $iframe->getAttribute('src'),
                $iframe->getAttribute('data-src'),
                $iframe->getAttribute('data-frame-src'),
            );

            foreach ($haystacks as $haystack) {
                if ( preg_match(
                    '/^https?:\/\/(?!([a-zA-Z0-9-]*\.)*(' . $this->config->getExclusions() . ')).*/',
                    $haystack,
                    $matches)
                ) {
                    $this->config->addResult($this->buildResult(
                        self::TYPE,
                        $iframe->getLineNo(),
                        $matches[0]
                    ));
                }
            }
        }
    }
}