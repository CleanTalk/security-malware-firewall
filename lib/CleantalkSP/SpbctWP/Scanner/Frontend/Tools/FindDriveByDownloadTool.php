<?php

namespace CleantalkSP\SpbctWP\Scanner\Frontend\Tools;

use CleantalkSP\SpbctWP\Scanner\Frontend\Models\PublicPageModel;

class FindDriveByDownloadTool extends FrontendTool
{
    const TYPE = 'dbd';
    public function analyse()
    {
        $dom = new \DOMDocument();
        $resultDomLoading = $dom->loadHTML($this->page->getContentPage(), LIBXML_NOERROR);

        if ($resultDomLoading === false) {
            // Что то делаем если дом не прогрузился
        }

        $tagIframes = $dom->getElementsByTagName('iframe');
        foreach ($tagIframes as $iframe) {
            $haystacks = array(
                $iframe->getAttribute('src'),
                $iframe->getAttribute('data-src'),
                $iframe->getAttribute('data-frame-src'),
            );

            foreach ($haystacks as $haystack) {
                echo $haystack;
                if ( preg_match(
                    '/^https?:\/\/(?!([a-zA-Z0-9-]*\.)*(' . $this->exclusions . ')).*/',
                    $haystack,
                    $matches)
                ) {
                    $this->problemsFound[] = array(
                        'type' => self::TYPE,
                        'code' => $matches[0],
                        'line' => $iframe->getLineNo()
                    );
                }
            }
        }

        return $this->getResult();
    }
}