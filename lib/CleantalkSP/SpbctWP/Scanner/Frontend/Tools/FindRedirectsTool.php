<?php

namespace CleantalkSP\SpbctWP\Scanner\Frontend\Tools;

use CleantalkSP\SpbctWP\Scanner\Frontend\Models\PublicPageModel;

class FindRedirectsTool extends FrontendTool
{
    const TYPE = 'redirect';

    public function analyse()
    {
        $dom = new \DOMDocument();
        $resultDomLoading = $dom->loadHTML($this->page->getContentPage(), LIBXML_NOERROR);

        if ($resultDomLoading === false) {
            // Что то делаем если дом не прогрузился
        }

        $tagScripts = $dom->getElementsByTagName('script');
        foreach ($tagScripts as $script) {
            if ( preg_match(
                '/location(?:\s*\.\s*href\s*)?\s*=\s*["\'](?:https?:\/\/)(?:www\.)?(?!' . $this->exclusions . ').*/',
                $script->nodeValue,
                $matches)
            ) {
                $this->problemsFound[] = array(
                    'type' => self::TYPE,
                    'code' => $matches[0],
                    'line' => $script->getLineNo()
                );
            }
        }

        return $this->getResult();
    }
}