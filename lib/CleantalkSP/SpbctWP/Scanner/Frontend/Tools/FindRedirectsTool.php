<?php

namespace CleantalkSP\SpbctWP\Scanner\Frontend\Tools;

use CleantalkSP\SpbctWP\Scanner\Frontend\Models\PublicPageModel;

class FindRedirectsTool implements FrontendMalwareInterface
{
    const TYPE = 'redirect';
    /**
     * @var PublicPageModel
     */
    private $page;
    private $exclusions;
    private $problemsFound = array();

    public function analyse()
    {
        $dom = new \DOMDocument();
        $resultDomLoading = $dom->loadHTML($this->page->getContentPage(), LIBXML_NOERROR);

        if ($resultDomLoading === false) {
            // Что то делаем если дом не прогрузился
        }

        $tagScripts = $dom->getElementsByTagName('script');
        foreach ($tagScripts as $script) {
            if ( preg_match(
                '/location(?:\s*\.\s*href\s*)?\s*=\s*["\'](?:https?:\/\/)(?:www\.)?(?!' . $this->exclusions . ').*/',
                $script->nodeValue,
                $matches)
            ) {
                $this->problemsFound[] = array(
                    'type' => self::TYPE,
                    'code' => $matches[0],
                    'line' => $script->getLineNo()
                );
            }
        }

        return $this->getResult();
    }

    public function getResult()
    {
        return $this->problemsFound;
    }

    public  function setPage(PublicPageModel $page)
    {
        $this->page = $page;
    }

    public  function setExclusions($exclusions)
    {
        $this->exclusions = $exclusions;
    }
}