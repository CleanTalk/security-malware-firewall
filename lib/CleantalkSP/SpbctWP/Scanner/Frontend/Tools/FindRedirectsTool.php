<?php

namespace CleantalkSP\SpbctWP\Scanner\Frontend\Tools;

class FindRedirectsTool extends FrontendAnalyzeTool
{
    const TYPE = 'redirect';

    public function analyse()
    {
        $dom = new \DOMDocument();
        $resultDomLoading = $dom->loadHTML($this->page->getContentPage(), LIBXML_NOERROR);

        if ($resultDomLoading === false) {
            // Что то делаем если дом не прогрузился
        }

        $tagScripts = $dom->getElementsByTagName('script');
        foreach ($tagScripts as $script) {
            if ( preg_match(
                '/location(?:\s*\.\s*href\s*)?\s*=\s*["\'](?:https?:\/\/)(?:www\.)?(?!' . $this->config->getExclusions() . ').*/',
                $script->nodeValue,
                $matches)
            ) {
                $this->config->addResult($this->buildResult(
                    self::TYPE,
                    $script->getLineNo(),
                    $matches[0]
                ));
            }
        }
    }
}