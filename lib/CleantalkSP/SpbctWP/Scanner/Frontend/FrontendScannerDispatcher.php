<?php

namespace CleantalkSP\SpbctWP\Scanner\Frontend;

use CleantalkSP\SpbctWP\Scanner\Frontend\Models\PublicPageModel;
use CleantalkSP\SpbctWP\Scanner\Frontend\Tools\FindRedirectsTool;

class FrontendScannerDispatcher
{
    const STAGES = array(
        FindRedirectsTool::class
    );
    /**
     * @var false|mixed|string|null
     */
    private $exclusionDomains;
    /**
     * @var false|mixed|null
     */
    private $homeUrl;
    private $results = array();

    public function __construct($exclusionDomains)
    {
        $exclusionDomains = str_replace(array("\r\n", "\n\r", "\r", "\n"), "\n", $exclusionDomains);
        $exclusionDomains = explode("\n", $exclusionDomains);

        $this->homeUrl = parse_url(get_option('home'), PHP_URL_HOST);

        $this->exclusionDomains = $exclusionDomains
            ?  $this->homeUrl . '|' . implode('|', $exclusionDomains)
            :  $this->homeUrl;
    }

    public function analyzePage(PublicPageModel $page)
    {
        // Проводит по всем этапам
        foreach (self::STAGES as $stage) {
            $stageHandler = new $stage();
            $stageHandler->setPage($page);
            $stageHandler->setExclusions($this->exclusionDomains);
            $this->results[$stage] = $stageHandler->analyse();
        }

        // Выдает результат
        dd($this->results);
    }
}