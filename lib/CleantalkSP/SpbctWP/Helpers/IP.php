<?php

namespace CleantalkSP\SpbctWP\Helpers;

class IP extends \CleantalkSP\Common\Helpers\IP
{
    public static function getIpData($ip) 
    {
        $networks = parent::convertIPv6ToFourIPv4(parent::extendIPv6(parent::normalizeIPv6(trim($ip, '"'))));

        // Get masks
        $masks = array();
        foreach ( $networks as $key => $network ) {
            $masks[$key] = $network ? '4294967295' : '0';
        }

        // get ID
        $id = md5(implode('', $networks) . '32' . '0');

        return array(
            'id' => $id,
            'networks' => $networks,
            'masks' => $masks,
            'country_code' => 0,
            'status' => 2
        );
    }
    
    /**
     * @param $ip_data
     *
     * @return bool|int|\mysqli_result|resource|null
     */
    public static function addIpToSpbcFirewallDataTable($ip_data)
    {
        global $wpdb;

        $table = SPBC_TBL_FIREWALL_DATA;
        $id = $ip_data['id'];
        $network1 = $ip_data['networks'][0];
        $network2 = $ip_data['networks'][1];
        $network3 = $ip_data['networks'][2];
        $network4 = $ip_data['networks'][3];
        $mask1 = $ip_data['masks'][0];
        $mask2 = $ip_data['masks'][1];
        $mask3 = $ip_data['masks'][2];
        $mask4 = $ip_data['masks'][3];
        $status = $ip_data['status'];
        $country_code = $ip_data['country_code'];

        $sql = "INSERT INTO $table
            (id, network1, network2, network3, network4, mask1, mask2, mask3, mask4, status, country_code)
            VALUES ('$id', $network1, $network2, $network3, $network4, $mask1, $mask2, $mask3, $mask4, $status, $country_code)
            ON DUPLICATE KEY UPDATE
            network1=network1, network2=network2, network3=network3, network4=network4,
            mask1=mask1, mask2=mask2, mask3=mask3, mask4=mask4,
            status=status, country_code=country_code";

        // Add to spbc_firewall_data
        return $wpdb->query($sql);
    }
}
