<?php

/**
 * Prepares properties for counters in $apbct
 * Handles counter reset
 *
 * @return void
 */
function spbc_admin__admin_bar__prepare_counters(){
    
    global $spbc;
    
    $spbc->counter__sum = 0;
    
    if( $spbc->settings['admin_bar__users_online_counter'] ){
        $spbc->counter__users_online = spbc_count_authorized_users( true );
        $spbc->counter__sum += $spbc->counter__users_online;
    }
    if( $spbc->settings['admin_bar__firewall_counter'] ){
        $spbc->counter__firewall_pass = \CleantalkSP\SpbctWP\Counters\FirewallCounter::get( 'pass' );
        $spbc->counter__firewall_deny = \CleantalkSP\SpbctWP\Counters\FirewallCounter::get( 'deny' );
        $spbc->counter__sum += $spbc->counter__firewall_pass + $spbc->counter__firewall_deny;
    }
    if( $spbc->settings['admin_bar__brute_force_counter'] ){
        $spbc->counter__logins_failed = \CleantalkSP\SpbctWP\Counters\SecurityCounter::get( 'auth_failed' );
        $spbc->counter__logins_passed = \CleantalkSP\SpbctWP\Counters\SecurityCounter::get( 'login' );
        $spbc->counter__sum += $spbc->counter__logins_failed + $spbc->counter__logins_passed;
    }
}

function spbc_admin__admin_bar__add_parent_icon( $icon ){
    
    return $icon
           . '<img class="cleantalk_admin_bar__spbc_icon" src="' . SPBC_PATH . '/images/logo_small_gray.png" alt="">&nbsp;';
}

function spbc_admin__admin_bar__add_counter( $after ){
    
    global $spbc;
    
    $counter__sum__layout = ( $after ? ' / ' : '<div class="cleantalk_admin_bar__sum_counter">' ) .
                            '<span title="All security events">' . ( $spbc->counter__sum - $spbc->counter__users_online ) . '</span>' .
                            ' / ' .
                            '<span title="Users online">' . $spbc->counter__users_online . '</span>' .
                            '</div>';
    
    return ( $after ? substr( $after, 0, -6 ) : $after )
           . $counter__sum__layout;
}

function spbc_admin__admin_bar__add_child_nodes( $wp_admin_bar ){
    
    global $spbc;

//    $attention_mark = $apbct->notice_show ? '<i class="icon-attention-alt"></i>' : '';
    
    // Users online counter
    if( $spbc->settings['admin_bar__users_online_counter'] ){
        $wp_admin_bar->add_node( array(
            'parent' => 'spbc__parent_node',
            'title'  => '<a><span>' . __( 'Users online:', 'security-malware-firewall' ) . '</span>'
                        . '&nbsp;<b class="spbc-admin_bar--user_counter">' . $spbc->counter__users_online . '</b></a>',
            'id'     => 'spbc_admin_bar__counter__online',
        ) );
    }
    
    // Failed / success login attempts counter
    if( $spbc->settings['admin_bar__brute_force_counter'] ){
        $wp_admin_bar->add_node( array(
            'parent' => 'spbc__parent_node',
            'id'     => 'spbc_admin_bar__counter__logins',
            'title'  => '<a><span>' . __('Logins:', 'security-malware-firewall') . '</span>&nbsp;'
                        . '<span style="color: white;" title="' . __('Blocked login attempts in the local database.', 'security-malware-firewall') . '">'
                        . '<span style="color: white;">'
                        . '<span style="color: green;">'
                        . $spbc->counter__logins_passed
                        . '</span> / '
                        . '<span style="color: red;">'
                        . $spbc->counter__logins_failed
                        . '</span>'
                        . '</span></a>',
        ) );
    }
    
    // Firewall blocked / allowed counter
    if( $spbc->settings['admin_bar__firewall_counter'] ){
        $wp_admin_bar->add_node( array(
            'parent' => 'spbc__parent_node',
            'id'     => 'spbc_admin_bar__counter__firewall',
            'title'  => '<a><span>' .__( 'Security Firewall: ', 'security-malware-firewall' ) .'</span>&nbsp;'
                        . '<span style="color: white;" title="'.__('Passed / Blocked requests by Security Firewall.', 'security-malware-firewall').'">'
                        . '<span style="color: green;">'
                        .$spbc->counter__firewall_pass
                        . '</span> / '
                        . '<span style="color: red;">'
                        .$spbc->counter__firewall_deny
                        . '</span>'
                        . '</span></a>',
        ) );
    }
    
    // Counter separator
    if( $spbc->counter__sum ){
        $wp_admin_bar->add_node( array(
            'parent' => 'spbc__parent_node',
            'id'     => 'spbc_admin_bar__separator',
            'title'  =>'<hr style="margin-top: 7px;" />',
            'meta' => array( 'class' => 'cleantalk_admin_bar__separator')
        ) );
    }
    
    // Settings
    $wp_admin_bar->add_node( array(
        'parent' => 'spbc__parent_node',
        'id'     => 'spbc_admin_bar__settings_link',
        'title'  => '<a href="' . $spbc->settings_link . '&spbc_tab=settings_general">' . __( 'Settings', 'security-malware-firewall' ) . '</a>',
    ) );
    
    // Scanner
    $wp_admin_bar->add_node( array(
        'parent' => 'spbc__parent_node',
        'id'     => 'spbc_admin_bar__scanner_link',
        'title'  => '<a style="display:inline" href="' . $spbc->settings_link . '&spbc_tab=scanner">' . __( 'Scanner', 'cleantalk-spam-protect' ) . '</a>'
                    . '/'
                    . '<a style="display:inline" href="' . $spbc->settings_link . '&spbc_tab=scanner&spbc_target=spbc_perform_scan&spbc_action=click">' . __( 'Start scan', 'security-malware-firewall' ) . '</a>'
    ) );
    
    // Support link
    $wp_admin_bar->add_node( array(
        'parent' => 'spbc__parent_node',
        'title'  => '<hr style="margin-top: 7px;" /><a target="_blank" href="https://wordpress.org/support/plugin/security-malware-firewall">' . __( 'Support', 'security-malware-firewall' ) . '</a>',
        'id'     => 'spbc_admin_bar__support_link',
    ) );
}

function spbc_apbct_admin__admin_bar__add_child_nodes( $wp_admin_bar ) {
    
    // Installation link
    $wp_admin_bar->add_node( array(
        'parent' => 'apbct__parent_node',
        'id'	 => 'apbct_admin_bar__install',
        'title'  => '<a target="_blank" href="plugin-install.php?s=Spam%20protection%2C%20AntiSpam%20by%20CleanTalk%20&tab=search">' . __( 'Install Anti-Spam by CleanTalk', 'security-malware-firewall' ) . '</a>',
    ) );
    
    $wp_admin_bar->add_node( array(
        'parent' => 'apbct__parent_node',
        'id'     => 'install_separator',
        'title'  =>'<hr style="margin-top: 7px;" />',
        'meta' => array( 'class' => 'cleantalk_admin_bar__separator' )
    ) );
    
    // User's counter
    $wp_admin_bar->add_node( array(
        'parent' => 'apbct__parent_node',
        'id'	 => 'apbct_admin_bar__counter__user',
        'title'  => '<a>' . __('Since', 'security-malware-firewall') . '&nbsp;' . date('M d') . ': '
                    . '<span style="color: green;">' . 0 . '</span> / '
                    . '<span style="color: red;">' . 0 . '</span></a>',
        'meta' => array( 'class' => 'cleantalk_admin_bar__blocked' ),
    ) );
    
    // All-time counter
    $wp_admin_bar->add_node( array(
        'parent' => 'apbct__parent_node',
        'id'     => 'apbct_admin_bar__counter__all_time',
        'title'  =>
            '<a><span title="' . __('All / Allowed / Blocked submissions. The number of submissions is being counted since CleanTalk plugin installation.', 'security-malware-firewall').'">'
            . __('Since installation', 'security-malware-firewall') .  ': '
            . '<span style="color: white;">' . 0 . '</span> / '
            . '<span style="color: green;">' . 0 . '</span> / '
            . '<span style="color: red;">' . 0 . '</span>'
            . '</span></a>',
        'meta' => array( 'class' => 'cleantalk_admin_bar__blocked' ),
    ) );
    
    // Daily counter
    $wp_admin_bar->add_node( array(
        'parent' => 'apbct__parent_node',
        'id'	 => 'apbct_admin_bar__counter__daily',
        'title'  =>
            '<a><span title="'.__('Allowed / Blocked submissions. The number of submissions for past 24 hours. ', 'security-malware-firewall').'">'
            . __('Day') . ': '
            . '<span style="color: green;">' . 0 . '</span> / '
            . '<span style="color: red;">' . 0 . '</span>'
            . '</span></a>',
        'meta' => array( 'class' => 'cleantalk_admin_bar__blocked' ),
    ) );
    
    // SFW counter
    $wp_admin_bar->add_node( array(
        'parent' => 'apbct__parent_node',
        'id'	 => 'apbct_admin_bar__counter__sfw',
        'title'  =>
            '<a><span title="'.__('All / Blocked events. Access attempts triggered by SpamFireWall counted since the last plugin activation.', 'security-malware-firewall').'">'
            . __('SpamFireWall', 'security-malware-firewall' ) . ': '
            . '<span style="color: white;">'. 0 . '</span> / '
            . '<span style="color: red;">' . 0 . '</span>'
            . '</span></a>',
        'meta' => array( 'class' => 'cleantalk_admin_bar__blocked' ),
    ) );
    
    // Counter separator
    $wp_admin_bar->add_node( array(
        'parent' => 'apbct__parent_node',
        'id'     => 'apbct_admin_bar__separator',
        'title'  =>'<hr style="margin-top: 7px;" />',
        'meta' => array( 'class' => 'cleantalk_admin_bar__separator')
    ) );
    
    $wp_admin_bar->add_node( array(
        'parent' => 'apbct__parent_node',
        'id'	 => 'ct_settings_link',
        'title'  => '<a>'.__('Settings').'</a>',
        'meta' => array( 'class' => 'cleantalk_admin_bar__blocked' ),
    ));
    
    // Add a child item to our parent item. Bulk checks.
    $wp_admin_bar->add_node( array(
        'parent' => 'apbct__parent_node',
        'id'	 => 'ct_settings_bulk_comments',
        'title'  => '<hr style="margin-top: 7px;" /><a>'.__('Bulk spam comments removal tool.', 'security-malware-firewall') . __('Check comments for spam', 'security-malware-firewall').'</a>',
        'meta' => array( 'class' => 'cleantalk_admin_bar__blocked' ),
    ) );
    
    // Add a child item to our parent item. Bulk checks.
    $wp_admin_bar->add_node( array(
        'parent' => 'apbct__parent_node',
        'id'	 => 'ct_settings_bulk_users',
        'title'  => '<a>'.__('Check users for spam', 'security-malware-firewall').'</a>',
        'meta' => array( 'class' => 'cleantalk_admin_bar__blocked' ),
    ) );
    
    // User counter reset.
    $wp_admin_bar->add_node( array(
        'parent' => 'apbct__parent_node',
        'id'	 => 'ct_reset_counter',
        'title'  => '<hr style="margin-top: 7px;"><a>'.__('Reset first counter', 'security-malware-firewall').'</a>',
        'meta' => array( 'class' => 'cleantalk_admin_bar__blocked' ),
    ) );// add a child item to our parent item. Counter reset.
    
    // Reset ALL counter
    $wp_admin_bar->add_node( array(
        'parent' => 'apbct__parent_node',
        'id'	 => 'ct_reset_counters_all',
        'title'  => '<a>'.__('Reset all counters', 'security-malware-firewall').'</a>',
        'meta' => array( 'class' => 'cleantalk_admin_bar__blocked' ),
    ) );
    
    // Support link
    $wp_admin_bar->add_node( array(
        'parent' => 'apbct__parent_node',
        'id'	 => 'ct_admin_bar_support_link',
        'title'  => '<hr style="margin-top: 7px;" /><a>'.__('Support', 'security-malware-firewall').'</a>',
        'meta' => array( 'class' => 'cleantalk_admin_bar__blocked' ),
    ));
}
