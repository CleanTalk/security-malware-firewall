<?php

use CleantalkSP\Updater\Updater;

class TestSecFWPrivateRecordsHandler extends PHPUnit\Framework\TestCase
{
    protected $cron_object;
    protected $sfw;

    protected function setUp()
    {
        Updater::runUpdateScripts('2.98', '2.99');
    }

    public function testEmptyActionPRH()
    {
        $this->expectException(Exception::class);
        spbct_sfw_private_records_handler('');
    }

    public function testWrongActionPRH()
    {
        $this->expectException(Exception::class);
        spbct_sfw_private_records_handler('update');
    }

    public function testEmptyDataPRHAdd()
    {
        $this->expectException(Exception::class);
        spbct_sfw_private_records_handler('add');
    }

    public function testDeleteEmptyDataPRH()
    {
        $this->expectException(Exception::class);
        spbct_sfw_private_records_handler('delete');
    }

    public function testGoodDataPRHAdd()
    {

        //multi

        spbct_sfw_private_records_handler('delete', '{"0":"424242424,323232323,1","1":"434343434,33333333,1"}');

        $this->assertEquals(
            '{"OK":{"total":2,"added":2,"updated":0,"ignored":0}}',
            spbct_sfw_private_records_handler('add', '{"0":"424242424,323232323,1","1":"434343434,33333333,1"}')
        );
        //next iteration returns ignorance
        $this->assertEquals(
            '{"OK":{"total":2,"added":0,"updated":0,"ignored":2}}',
            spbct_sfw_private_records_handler('add', '{"0":"424242424,323232323,1","1":"434343434,33333333,1"}')
        );
        //next iteration returns updating
        $this->assertEquals(
            '{"OK":{"total":2,"added":0,"updated":2,"ignored":0}}',
            spbct_sfw_private_records_handler('add', '{"0":"424242424,323232323,0","1":"434343434,33333333,0"}')
        );

        //single

        spbct_sfw_private_records_handler('delete', '{"0":"424242424,323232323,1","1":"434343434,33333333,1"}');

        $this->assertEquals(
            '{"OK":{"total":1,"added":1,"updated":0,"ignored":0}}',
            spbct_sfw_private_records_handler('add', '{"0":"424242424,323232323,99"}')
        );
        //next iteration returns ignorance
        $this->assertEquals(
            '{"OK":{"total":1,"added":0,"updated":0,"ignored":1}}',
            spbct_sfw_private_records_handler('add', '{"0":"424242424,323232323,99"}')
        );
        //next iteration returns updating
        $this->assertEquals(
            '{"OK":{"total":1,"added":0,"updated":1,"ignored":0}}',
            spbct_sfw_private_records_handler('add', '{"0":"424242424,323232323,0"}')
        );
    }

    public function testDataValidatePRHAdd()
    {
        $this->expectExceptionMessage('network');
        spbct_sfw_private_records_handler('add', '{"0":"adsd,323232323,1","1":"434343434,33333333,1"}');
        $this->expectExceptionMessage('network');
        spbct_sfw_private_records_handler('add', '{"0":"0,823232323,1"}');

        $this->expectExceptionMessage('mask');
        spbct_sfw_private_records_handler('add', '{"0":"424242424,adsd,1","1":"434343434,33333333,1"}');
        $this->expectExceptionMessage('mask');
        spbct_sfw_private_records_handler('add', '{"0":"424242424,323232323,1","1":"434343434,adsd,1"}');
        $this->expectExceptionMessage('status');
        spbct_sfw_private_records_handler('add', '{"0":"424242424,323232323,adsd","1":"434343434,33333333,1"}');
        $this->expectExceptionMessage('status');
        spbct_sfw_private_records_handler('add', '{"0":"424242424,323232323,","1":"434343434,33333333,1"}');
        $this->expectExceptionMessage('status');
        spbct_sfw_private_records_handler('add', '{"0":"424242424,323232323,9","1":"434343434,33333333,1"}');
        $this->expectExceptionMessage('status');
        spbct_sfw_private_records_handler('add', '{"0":"424242424,323232323,-2","1":"434343434,33333333,1"}');

    }

    public function testPRHDeleteBadData()
    {
        $this->expectExceptionMessage('network');
        spbct_sfw_private_records_handler('delete', '{"0":"adsd,323232323,1","1":"434343434,33333333,1"}');
        $this->expectExceptionMessage('mask');
        spbct_sfw_private_records_handler('delete', '{"0":"424242424,adsd,1","1":"434343434,33333333,1"}');
        $this->expectExceptionMessage('mask');
        spbct_sfw_private_records_handler('delete', '{"0":"424242424,323232323,1","1":"434343434,adsd,1"}');

    }

    public function testPRHDeleteGoodData()
    {

        //multi

        $this->assertEquals(
            '{"OK":{"total":2,"added":2,"updated":0,"ignored":0}}',
            spbct_sfw_private_records_handler('add', '{"0":"2509938159,4294967295,1","1":"2509938150,4294967295,1"}')
        );

        $this->assertEquals(
            '{"OK":{"total":2,"deleted":2,"ignored":0}}',
            spbct_sfw_private_records_handler('delete', '{"0":"2509938159,4294967295,1","1":"2509938150,4294967295,1"}')
        );

        //next iteration returns ignorance
        $this->assertEquals(
            '{"OK":{"total":2,"deleted":0,"ignored":2}}',
            spbct_sfw_private_records_handler('delete', '{"0":"2509938159,4294967295,1","1":"2509938150,4294967295,1"}')
        );

        spbct_sfw_private_records_handler('add', '{"0":"424242424,323232323,1"}');

        //ignore one of them
        $this->assertEquals(
            '{"OK":{"total":2,"deleted":1,"ignored":1}}',
            spbct_sfw_private_records_handler('delete', '{"0":"424242424,323232323,0","1":"434343434,33333333,0"}')
        );

        //single

        spbct_sfw_private_records_handler('add', '{"0":"424242424,323232323,1"}');

        $this->assertEquals(
            '{"OK":{"total":1,"deleted":1,"ignored":0}}',
            spbct_sfw_private_records_handler('delete', '{"0":"424242424,323232323,1"}')
        );
        //next iteration returns ignorance
        $this->assertEquals(
            '{"OK":{"total":1,"deleted":0,"ignored":1}}',
            spbct_sfw_private_records_handler('delete', '{"0":"424242424,323232323,1"}')
        );
    }
}
