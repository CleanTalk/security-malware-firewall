<?php

namespace CleantalkSP\SpbctWP\Firewall;

use CleantalkSP\SpbctWP\Activator;
use CleantalkSP\SpbctWP\DB;
use PHPUnit\Framework\TestCase;

class FWTest extends TestCase
{
    /**
     * @throws \Exception
     */
    public function setUp()
    {
        Activator::activation(false);
    }

    public function getFWModuleInstance() {
        global $spbc;

        spbc_update_actions();

        // Necessary: Load Security FireWall module
        $firewall =
            new FW(
                array(
                    'data_table__common'             => SPBC_TBL_FIREWALL_DATA,
                    'data_table__personal'           => SPBC_TBL_FIREWALL_DATA__IPS,
                    'data_table__personal_countries' => SPBC_TBL_FIREWALL_DATA__COUNTRIES,
                    'log_table'                      => SPBC_TBL_FIREWALL_LOG,
                    'state'                          => $spbc,
                    'api_key'                        => $spbc->api_key,
                    'cookie_domain'                  => parse_url(get_option('home'), PHP_URL_HOST),
                    'data__set_cookies'              => $spbc->settings['data__set_cookies'],
                )
            );

        $firewall->setDb(DB::getInstance());
        return $firewall;
    }

    public function testCheckIPV6SingleRecord()
    {
        spbct_sfw_private_records_handler(
            'add',
            '{"0":"2001:0db8:85a3:0000:0000:8a2e:0370:7339,128,0"}'
        );

        // Necessary: Load Security FireWall module
        $firewall = $this->getFWModuleInstance();

        $firewall->setIpArray(array('test' => '2001:0db8:85a3:0000:0000:8a2e:0370:7339'));
        $result = $firewall->check();
        $result_status = $result[0]->status;
        $this->assertEquals('DENY', $result_status);

        spbct_sfw_private_records_handler(
            'delete',
            '{"0":"2001:0db8:85a3:0000:0000:8a2e:0370:7339,128,0"}'
        );
    }

    public function testCheckIPV6Network()
    {
        spbct_sfw_private_records_handler(
            'add',
            '{"0":"2001:67c:21f0::,48,0"}'
        );

        // Necessary: Load Security FireWall module
        $firewall = $this->getFWModuleInstance();

        $firewall->setIpArray(array('test' => '2001:67c:21f0:0000:0000:8a2e:0370:7339'));
        $result = $firewall->check();
        $result_status = $result[0]->status;
        $this->assertEquals('DENY', $result_status);

        $firewall->setIpArray(array('test' => '2001:67c:21f1:0000:0000:8a2e:0370:7339'));
        $result = $firewall->check();
        $result_status = $result[0]->status;
        $this->assertEquals('PASS', $result_status);

        spbct_sfw_private_records_handler(
            'delete',
            '{"0":"2001:67c:21f0::,48,0"}'
        );
    }

    public function testCheckIPV4SingleRecord()
    {
        spbct_sfw_private_records_handler(
            'add',
            '{"0":"3007753698,4294967295,0"}'
        );

        // Necessary: Load Security FireWall module
        $firewall = $this->getFWModuleInstance();

        $firewall->setIpArray(array('test' => '179.70.173.226'));
        $result = $firewall->check();
        $result_status = $result[0]->status;
        $this->assertEquals('DENY', $result_status);

        spbct_sfw_private_records_handler(
            'delete',
            '{"0":"3007753698,4294967295,0"}'
        );
    }

    public function testCheckIPV4Network()
    {
        spbct_sfw_private_records_handler(
            'add',
            '{"0":"3014762496,4294963200,0"}'
        );

        // Necessary: Load Security FireWall module
        $firewall = $this->getFWModuleInstance();

        $firewall->setIpArray(array('test' => '179.177.173.226'));
        $result = $firewall->check();
        $result_status = $result[0]->status;
        $this->assertEquals('DENY', $result_status);

        $firewall->setIpArray(array('test' => '179.177.176.12'));
        $result = $firewall->check();
        $result_status = $result[0]->status;
        $this->assertEquals('PASS', $result_status);

        spbct_sfw_private_records_handler(
            'delete',
            '{"0":"3014762496,4294963200,0"}'
        );
    }
}
