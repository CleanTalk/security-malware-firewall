// Callback for displaying Firewall logs
function spbc_tc__show_more__callback(result, data, params) {
    if (data.full_refresh) {
        jQuery(params.wrapper).html(result);
        spbcTblRowActionsListen();
        spbcTblPaginationListen();
        spbcTblSortListen();
        spbcStartShowHide();
    } else if (result.size > 0) {
        jQuery(params.wrapper).html(result.html);
        spbcTblRowActionsListen();
        spbcStartShowHide();
    } else {
        // Hide "More logs" button, show "Control Panel" button
        jQuery(params.button).hide();
        jQuery(params.button).siblings('.spbc__show_more_logs').css('display', 'inline-block');
    }
}

function spbc_tc__show_more__listen() {
    jQuery('#spbc_show_more_fw_logs_button').on('click', function() {
        if (spbcSettingsFWLogs.clicks < 2) {
            spbcSettingsFWLogs.clicks++;
            let data = {
                action: 'spbc_show_more_security_firewall_logs',
                amount: spbcSettingsFWLogs.amount * (+spbcSettingsFWLogs.clicks+1),
            };
            let params = {
                button: this,
                spinner: this.nextElementSibling,
                wrapper: jQuery('#spbc_tbl__traffic_control_logs').find('tbody'),
                callback: spbc_tc__show_more__callback,
            };
            spbcSendAJAXRequest( data, params );
        } else {
            // Hide "More logs" button, show "Control Panel" button
            jQuery(this).hide();
            jQuery(this).siblings('.spbc__show_more_logs').css('display', 'inline-block');
        }
    });
}

jQuery(document).ready(function() {
    spbcTblRowActionsListen(); // Table. Row actions handler
    spbcTblPaginationListen(); // Table. Pagination handler
    spbcTblSortListen(); // Table. Sort handler

    // Start to hide long values in a table
    spbcStartShowHide();

    // FIREWALL LOGS EVENTS

    // Handler for show more FIREWALL LOGS
    spbc_tc__show_more__listen();

    // Timer for FireWall logs
    let spbcFireWallLogsUpdateTimer = setTimeout(function spbc_heartbeat() {
        // Do refresh only if traffic control is enabled and tab is active
        if ( +spbcSettingsFWLogs.moderate && jQuery('.spbc_tab_nav-traffic_control').hasClass('spbc_tab_nav--active')) {
            let data = {
                action: 'spbc_show_more_security_firewall_logs',
                full_refresh: true,
            };
            let params = {
                wrapper: jQuery('#spbc_tbl__traffic_control_logs'),
                callback: spbc_tc__show_more__callback,
                notJson: true,
            };
            spbcSendAJAXRequest( data, params );
        }
        setTimeout(spbc_heartbeat, 60000);
    }, 60000);
});

function spbc_tc__allow_ip(ip) {
    spbc_tc__filter_ip( ip, 'allow');
    return false;
}

function spbc_tc__ban_ip(ip) {
    spbc_tc__filter_ip( ip, 'deny');
    return false;
}

function spbc_tc__filter_ip( ip, status) {
    const data = {
        action: 'spbc_tc__filter_ip',
        ip: ip,
        status: status,
    };
    const params = {
        callback: spbc_tc__allow_ip__callback,
    };
    spbcSendAJAXRequest( data, params );
    return false;
}

function spbc_tc__allow_ip__callback(data) {
    if (data.success) {
        alert('Success.');
    } else {
        alert(data.data);
    }
}
