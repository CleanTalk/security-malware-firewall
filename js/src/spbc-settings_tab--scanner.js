function spbc_popup_tip___show(show_icon){

	var tip_title = show_icon.attr('spbc_tip_title') || null;
	var	tip_text  = show_icon.attr('spbc_tip_text')  || null;
	var remove_desc_func = function(e){

		if(
			typeof e === 'undefined' ||
			(
				(jQuery(e.target).parent('.spbc_popup_tip--wrapper').length == 0 || jQuery(e.target).hasClass('spbc_popup_tip--icon---cancel')) &&
				!jQuery(e.target).hasClass('spbc_popup_tip--icon---show')
			)
		){
			jQuery('.spbc_popup_tip--wrapper').hide();
			jQuery(document).off('click', remove_desc_func);
		}
	};

	remove_desc_func();

	show_icon.after("<div class='spbc_popup_tip--wrapper'></div>");

	var obj = jQuery('.spbc_popup_tip--wrapper');

	obj.empty()
		.append("<div class='spbc_popup_tip--angle'></div>")
		.css({
			top: show_icon.position().top - 2,
			left: show_icon.position().left + 25
		});
	obj.append("<i class='spbc_popup_tip--icon---cancel icon-cancel'></i>")
		.append("<h3 class='spbc_popup_tip--title'>" + tip_title + "</h3>")
		.append("<p class='spbc_popup_tip--text'>" + tip_text + "</p>");

	jQuery(document).on('click', remove_desc_func);
	show_icon.parents('tr').on('mouseout', remove_desc_func);
}

function spbc_scanner_button_file_view_event(obj){
	var self = jQuery(obj);
	var data = {
		action: 'spbc_scanner_file_view',
		file_id: self.parent().attr('uid'),
	};
	var params = {
		spinner: self.parent().siblings('.tbl-preloader--tiny'),
		callback: spbc_scannerButtonView_callback,
	};
	spbc_sendAJAXRequest(data, params);
}

function spbc_scanner_button_page_view_event(obj){
	var self = jQuery(obj);
	var data = {
		action: 'spbc_scanner_page_view',
		page_url: self.parent().attr('uid'),
	};
	var params = {
		spinner: self.parent().siblings('.tbl-preloader--tiny'),
		callback: spbc_scannerButtonView_callback,
	};
	spbc_sendAJAXRequest(data, params);
}

function spbc_scannerButtonView_callback(result, data, params){
	console.log('FILE_VIEWED');
	var row_template = '<div class="spbc_view_file_row_wrapper"><span class="spbc_view_file_row_num">%s</span><p class="spbc_view_file_row">%s</p><br /></div>';
	jQuery('#spbc_dialog').empty();
	for(row in result.file){
		jQuery('#spbc_dialog').append(row_template.printf(row, result.file[row]));
	}
	
	var content_height = Object.keys(result.file).length * 19 + 19,
		visible_height = (document.documentElement.clientHeight) / 100 * 75;
		content_height = content_height < 76 ? 76 : content_height;
	var overflow = content_height < visible_height ? 'no_scroll' : 'scroll';
	
	jQuery('#spbc_dialog').data('overflow', overflow);
	jQuery('#spbc_dialog').dialog({
		modal:true, 
		title: result.file_path,
		position: { my: "center top", at: "center top+40px" , of: window },
		width: +(jQuery('#wpbody').width() / 100 * 70),
		height: overflow == 'scroll' ? visible_height : content_height,
		show: { effect: "blind", duration: 500 },
		draggable: false,
		resizable: false,
		closeText: "X",
		open: function(event, ui) {
			console.log(jQuery(event.target).data('overflow'));
			document.body.style.overflow = 'hidden';
			if(jQuery(event.target).data('overflow') == 'scroll') event.target.style.overflow = 'scroll';
		},
		beforeClose: function(event, ui) { document.body.style.overflow = 'auto'; },
	});
}

function spbc_scanner_button_file_view_bad_event(obj){
	var self = jQuery(obj);
	var data = {
		action: 'spbc_scanner_file_view',
		file_id: self.parent().attr('uid'),
	};
	var params = {
		spinner: self.parent().siblings('.tbl-preloader--tiny'),
		callback: spbc_scannerButtonViewBad_callback,
	};
	spbc_sendAJAXRequest(data, params);
}

function spbc_scanner_button_page_view_bad_event(obj){
	var self = jQuery(obj);
	var data = {
		action: 'spbc_scanner_page_view',
		page_url: self.parent().attr('uid'),
	};
	var params = {
		spinner: self.parent().siblings('.tbl-preloader--tiny'),
		callback: spbc_scannerButtonViewBad_callback,
	};
	spbc_sendAJAXRequest(data, params);
}

function spbc_scannerButtonViewBad_callback(result, data, params){
	console.log('FILE_VIEWED_BAD_CODE');
	console.log(arguments);
//	result.weak_spots = JSON.parse(result.weak_spots);
	var row_template     = '<div class="spbc_view_file_row_wrapper"><span class="spbc_view_file_row_num">%s</span><p class="spbc_view_file_row">%s</p><br /></div>';
	var row_template_bad = '<div class="spbc_view_file_row_wrapper" style="background: rgba(200,40,40,0.8);"><span class="spbc_view_file_row_num">%s</span><p class="spbc_view_file_row">%s</p><br /></div>';
	var str_nums = [];
	jQuery('#spbc_dialog').empty();
	result.weak_spots = JSON.parse(result.weak_spots);
	for(var severity in result.weak_spots){
		str_nums = str_nums.concat(Object.keys(result.weak_spots[severity]));
	}
	for(str_num in str_nums){
		var row = str_nums[str_num];
		if(typeof result.file[row] !== 'undefined'){
			jQuery('#spbc_dialog').append(row_template.    printf(row-2, result.file[row-2]));
			jQuery('#spbc_dialog').append(row_template.    printf(row-1, result.file[row-1]));
			jQuery('#spbc_dialog').append(row_template_bad.printf(row,   result.file[row]));
			jQuery('#spbc_dialog').append(row_template.    printf(+row+1, result.file[+row+1]));
			jQuery('#spbc_dialog').append(row_template.    printf(+row+2, result.file[+row+2]));
			jQuery('#spbc_dialog').append(row_template.    printf('', ''));
		}
	}
	 
	var content_height = jQuery('#spbc_dialog').length * 19 + 19,
		visible_height = (document.documentElement.clientHeight) / 100 * 75;
		content_height = content_height < 76 ? 76 : content_height;
	var overflow = content_height < visible_height ? 'no_scroll' : 'scroll';
	
	jQuery('#spbc_dialog').data('overflow', overflow);
	jQuery('#spbc_dialog').dialog({
		modal:true, 
		title: result.file_path,
		position: { my: "center top", at: "center" , of: window },
		width: +(jQuery('#wpbody').width() / 100 * 70),
		// height: "overflow == 'scroll' ? visible_height : content_height",
		show: { effect: "blind", duration: 500 },
		draggable: true,
		resizable: false,
		closeText: "X",
		open: function(event, ui) {
			console.log(jQuery(event.target).data('overflow'));
			document.body.style.overflow = 'hidden';
			if(jQuery(event.target).data('overflow') == 'scroll') event.target.style.overflow = 'scroll';
		},
		beforeClose: function(event, ui) { document.body.style.overflow = 'auto'; },
	});
}

function spbc_scanner_button_file_compare_event(obj){
	var self = jQuery(obj);
	var data = {
		action: 'spbc_scanner_file_compare',
		file_id: self.parent().attr('uid'),
	};
	var params = {
		spinner: self.parent().siblings('.tbl-preloader--tiny'),
		callback: spbc_scannerButtonFileCompare_callback,
	};
	spbc_sendAJAXRequest(data, params);
}

function spbc_scannerButtonFileCompare_callback(result, data, params){
	console.log('FILE_COMPARED');
	var row_template = '<div class="spbc_compare_file_row_wrapper"><span class="spbc_compare_file_row_num">%s</span><p class="spbc_compare_file_row">%s</p><p class="spbc_compare_file_row">%s</p><br /></div>';
	var row_template_bad = '<div class="spbc_compare_file_row_wrapper" style="background: rgba(200,40,40,0.8);"><span class="spbc_compare_file_row_num">%s</span><p class="spbc_compare_file_row">%s</p><p class="spbc_compare_file_row">%s</p><br /></div>';
	jQuery('#spbc_dialog').empty();
	for(var row=1, prev = false, next = false; typeof result.file[row] != 'undefined' || typeof result.file_original[row] != 'undefined'; row++){
		if(typeof result.file[row] == 'undefined')          result.file[row] = '';
		if(typeof result.file_original[row] == 'undefined') result.file_original[row] = '';
		if(result.difference.indexOf(row) != -1){
			jQuery('#spbc_dialog').append(row_template.printf(row-2, result.file[row-2] ? result.file[row-2] : '', result.file_original[row-2] ? result.file_original[row-2] : ''));
			jQuery('#spbc_dialog').append(row_template.printf(row-1, result.file[row-1] ? result.file[row-1] : '', result.file_original[row-1] ? result.file_original[row-1] : ''));
			jQuery('#spbc_dialog').append(row_template_bad.printf(row,   result.file[row],   result.file_original[row]));
			jQuery('#spbc_dialog').append(row_template.printf(row+1, result.file[row+1] ? result.file[row+1] : '', result.file_original[row+1] ? result.file_original[row+1] : ''));
			jQuery('#spbc_dialog').append(row_template.printf(row+2, result.file[row+2] ? result.file[row+2] : '', result.file_original[row+2] ? result.file_original[row+2] : ''));
		}
	}
	
	var content_height = jQuery('#spbc_dialog div').length * 19 + 19,
		visible_height = (document.documentElement.clientHeight) / 100 * 75;
	var overflow = content_height < visible_height ? 'no_scroll' : 'scroll';
	
	jQuery('#spbc_dialog').data('overflow', overflow);
	jQuery('#spbc_dialog').dialog({
		modal:true, 
		title: result.file_path,
		position: { my: "center top", at: "center top+40px" , of: window },
		width: 700, //+(jQuery('#wpbody').width() / 100 * 70),
		height: overflow == 'scroll' ? visible_height + 20 : content_height + 20,
		show: { effect: "blind", duration: 500 },
		draggable: true,
		resizable: false,
		closeText: "X",
		open: function(event, ui) {
			console.log(jQuery(event.target).data('overflow'));
			document.body.style.overflow = 'hidden';
			if(jQuery(event.target).data('overflow') == 'scroll') event.target.style.overflow = 'scroll';
		},
		beforeClose: function(event, ui) { document.body.style.overflow = 'auto'; }
	});
}

jQuery(document).ready(function(){
	
	// EVENT HADLING
	spbc_tbl__bulk_actions__listen(); // Table. Row bulk handler
	spbc_tbl__row_actions__listen();  // Table. Row actions handler
	spbc_tbl__pagination__listen();   // Table. Pagination handler
	spbc_tbl__sort__listen();         // Table. Sort handler
	
	spbcStartShowHide();

	// Preparing progressbar
	jQuery('#spbc_scaner_progress_bar').progressbar({
		value: 0,
		create: function( event, ui ) {
			event.target.style.position = 'relative';
			event.target.style.marginBottom = '12px';
		},
		change: function(event, ui){
			jQuery('.spbc_progressbar_counter span').text(jQuery(event.target).progressbar('option', 'value') + ' %');
		},
	});
	
	// Preparing accordion
	jQuery('#spbc_scan_accordion').accordion({
		header: "h3",
		heightStyle: 'content',
		collapsible: true,
		active: false,
		beforeActivate: function(event, ui){
			// jQuery( "#spbc_scan_accordion" ).accordion( "option", "active", 2 );
		},
	});
	
	// Init scanner plugin
	jQuery('#spbc_perform_scan').spbcScannerPlugin({
		status: null,
		paused: false,
		button: jQuery('#spbc_perform_scan'),
		spinner: jQuery('#spbc_perform_scan').next(),
		callback: null,
		progress_overall: jQuery('#spbc_scaner_progress_overall'),
		progressbar: jQuery('#spbc_scaner_progress_bar'),
		progressbar_text: jQuery('.spbc_progressbar_counter span'),
		wrapper: document.getElementsByClassName('spbc_unchecked_file_list'),
		warnings: {
		    long_scan: jQuery('.spbc_hint_warning__long_scan'),
            outdated:  jQuery('.spbc_hint_warning__outdated')
        }
	});

	jQuery(document).on('click', '.spbc_popup_tip--icon---show', function(){
		spbc_popup_tip___show( jQuery( this ) );
	});

	jQuery('#spbc_perform_scan').on('click', function(){
		jQuery.spbc.scanner.control(null, null, true);
	});
	
	//DEBUG
		// Clear table
		jQuery('#spbc_scanner_clear').on('click', function(){
			jQuery.spbc.scanner.clear();
		});
	
});