"use strict";class spbcMalwareScanner{first_start=!0;active=!1;root="";settings=[];states=["get_cms_hashes","get_modules_hashes","clean_results","file_system_analysis","get_approved_hashes","get_denied_hashes","signature_analysis","heuristic_analysis","schedule_send_heuristic_suspicious_files","auto_cure_backup","auto_cure","outbound_links","frontend_analysis","important_files_listing","send_results"];state=null;offset=0;amount=0;amount_coefficient=1;total_scanned=0;scan_percent=0;percent_completed=0;paused=!1;button=null;spinner=null;progress_overall=null;progressbar=null;progressbar_text=null;timeout=6e4;state_timer=0;constructor(s){for(var t in console.log("init"),jQuery("#spbcscan-results-log-module").length&&jQuery(".spbc-scan-log-title").removeClass("spbc---hidden"),void 0!==s.settings.auto_cure&&(s.settings.scanner__auto_cure_backup="1"),s)void 0!==this[t]&&(this[t]=s[t])}actionControl(){null===this.state?this.start():this.paused?(this.resume(),this.controller()):this.pause()}start(){this.active=!0,this.state_timer=Math.round((new Date).getTime()/1e3),this.state=this.getNextState(null),this.setPercents(0),this.scan_percent=0,this.offset=0,this.progress_overall.children("span").removeClass("spbc_bold").filter(".spbc_overall_scan_status_"+this.state).addClass("spbc_bold"),this.progressbar.show(500),this.progress_overall.show(500),this.button.html(spbcScaner.button_scan_pause),this.spinner.css({display:"inline"}),setTimeout(()=>{this.controller()},1e3)}pause(s,t,e){console.log("PAUSE"),this.button.html(spbcScaner.button_scan_resume),this.spinner.css({display:"none"}),this.paused=!0,this.active=!1}resume(s){console.log("RESUME"),this.button.html(spbcScaner.button_scan_pause),this.spinner.css({display:"inline"}),this.paused=!1,this.active=!0}end(s){this.progressbar.hide(500),this.progress_overall.hide(500),this.button.html(spbcScaner.button_scan_perform),this.spinner.css({display:"none"}),this.state=null,this.total_links=0,this.plug=!1,this.total_scanned=0,this.active=!1,s?document.location=document.location:(spbcSendAJAXRequest({action:"spbc_scanner_tab__reload_accordion"},{notJson:!0,callback:function(s,t,e,i){jQuery(i).accordion("destroy").html(s).accordion({header:"h3",heightStyle:"content",collapsible:!0,active:!1}),spbcTblBulkActionsListen(),spbcTblRowActionsListen(),spbcTblPaginationListen(),spbcTblSortListen(),spbcStartShowHide(),spbc_scanner__reload_scan_info()}},jQuery("#spbc_scan_accordion")),jQuery("#spbc_scanner_clear").length||jQuery('<p id="spbc_scanner_clear" class="spbc_hint spbc_hint-send_security_log spbc_hint--link spbc_hint--top_right" onclick="spbc_scanner_button_clear_scan_results()">Clear scanner logs</p><br>').insertBefore("#spbcscan-scanner-caption"))}controller(s){if(console.log(this.state),void 0!==s&&s.end){if(this.state=this.getNextState(this.state),void 0===this.state)return void this.end();this.setPercents(0),this.scan_percent=0,this.offset=0,this.progress_overall.children("span").removeClass("spbc_bold").filter(".spbc_overall_scan_status_"+this.state).addClass("spbc_bold")}if(!0!==this.paused){var t={action:"spbc_scanner_controller_front",method:this.state,offset:this.offset},s={type:"GET",success:this.success,callback:this.successCallback,error:this.error,errorOutput:this.errorOutput,complete:null,context:this,timeout:12e4};switch(this.state){case"get_modules_hashes":this.amount=2;break;case"clear_table":this.amount=1e4;break;case"file_system_analysis":this.amount=700;break;case"auto_cure":this.amount=5;break;case"outbound_links":this.amount=10;break;case"frontend_analysis":this.amount=spbcSettings.frontendAnalysisAmount;break;case"signature_analysis":this.amount=10,t.status="UNKNOWN,MODIFIED,OK,INFECTED,ERROR";break;case"heuristic_analysis":this.amount=4,t.status="UNKNOWN,MODIFIED,OK,INFECTED,ERROR";break;case"schedule_send_heuristic_suspicious_files":this.amount=1}t.amount=Math.round(this.amount*this.amount_coefficient),spbcSendAJAXRequest(t,s,jQuery("#spbc_scan_accordion"))}}setCoefficients(s){let t=this.amount_coefficient;"file_system_analysis"===s&&(t*=1.5),this.amount_coefficient=t}getNextState(s){return s=null===s?this.states[0]:this.states[this.states.indexOf(s)+1],s=void 0!==this.settings["scanner__"+s]&&0==+this.settings["scanner__"+s]?this.getNextState(s):s}setPercents(s){this.percent_completed=Math.floor(100*s)/100,this.progressbar.progressbar("option","value",this.percent_completed),this.progressbar_text.text(spbcScaner["progressbar_"+this.state]+" - "+this.percent_completed+"%")}success(s){s.error?this.error({status:200,responseText:s.error},s.error,s.msg):this.successCallback&&this.successCallback(s,this.data,this.obj)}successCallback(s){console.log(s),void 0!==s.total&&(this.scan_percent=100/s.total),void 0!==s.processed_items&&("heuristic_analysis"===this.state&&0!==typeof s.total&&this.logRaw('<h3 class="spbc_log-block_header">Heuristic Analysis</h3>'),"signature_analysis"===this.state&&0!==typeof s.total&&this.logRaw('<h3 class="spbc_log-block_header">Signature Analysis</h3>'),this.logFileEntry(s.processed_items)),void 0!==s.stage_data_for_logging&&this.logStageEntry(s.stage_data_for_logging),void 0!==s.cured&&0<Number(s.cured)&&this.showLinkForShuffleSalts(s.message),!0!==s.end&&1!==s.end?(this.setPercents(this.percent_completed+s.processed*this.scan_percent),this.offset=this.offset+s.processed,this.controller(s)):(console.log(this.state+" stage took "+(Math.round((new Date).getTime()/1e3)-this.state_timer)+" seconds to complete"),this.state_timer=Math.round((new Date).getTime()/1e3),this.setPercents(100),this.scan_percent=0,this.offset=0,setTimeout(()=>{this.controller(s)},300))}error(s,t,e){var i=this.errorOutput;if(console.log("%c APBCT_AJAX_ERROR","color: red;"),console.log(t),console.log(e),console.log(s),"error"==t&&(""==e||"Not found"==e)&&(this.tryCount||(this.tryCount=0,this.retryLimit=30),this.tryCount++,console.log("Try #"+this.tryCount),this.setCoefficients(this.state),this.tryCount<=this.retryLimit))this.pause(),this.resume(),this.controller();else{if(200===s.status)if("parsererror"===t)i("Unexpected response from server. See console for details.",this.state),console.log("%c "+s.responseText,"color: pink;");else{let s=t;void 0!==e&&(s+=" Additional info: "+e),i(s,this.state)}else 500===s.status?i("Internal server error.",this.state):i("Unexpected response code: "+s.status+". Error: "+t,this.state);this.progressbar&&this.progressbar.fadeOut("slow"),this.end()}}errorOutput(s,t){spbcModal.open().putError(s+"<br>Stage: "+t)}logRaw(s){jQuery(".spbc-scan-log-title").removeClass("spbc---hidden"),jQuery(".spbc_log-wrapper").removeClass("spbc---hidden"),jQuery(".spbc_log-wrapper .panel-body").prepend(s)}logFileEntry(s){for(var t in s)t&&this.logRaw('<p class="spbc_log-line">'+this.getSiteUTCShiftedTimeString()+" - "+s[t].path+"<b>: "+s[t].status+"</b></p>")}logStageEntry(s){void 0!==jQuery(".panel-body  .spbc_log-line span").first()&&void 0!==jQuery(".panel-body  .spbc_log-line span").first()[0]&&jQuery(".panel-body  .spbc_log-line span").first()[0].textContent===s.description||this.logRaw('<p class="spbc_log-line">test '+this.getSiteUTCShiftedTimeString()+" - <b>"+s.title+"</b> <span>"+s.description+"</span></p>")}showLinkForShuffleSalts(s){jQuery("#spbc_notice_about_shuffle_link").remove(),jQuery(jQuery(".spbc_tab--active .spbc_wrapper_field p")[1]).after('<div style="text-align: center;" id="spbc_notice_about_shuffle_link"><a href="options-general.php?page=spbc&spbc_tab=settings_general#action-shuffle-salts-wrapper">'+s+"</a></div>")}getSiteUTCShiftedTimeString(){let s=!1;var t=-1*(new Date).getTimezoneOffset()*1e3*60,t=(s="undefined"!=typeof spbcScaner&&void 0!==spbcScaner.timezone_shift&&!1!==spbcScaner.timezone_shift?Date.now()-t+1e3*spbcScaner.timezone_shift:s)?new Date(s):new Date,e=new Intl.DateTimeFormat("en-US",{month:"short"}).format,i=String(t.getMinutes()).padStart(2,"0"),a=String(t.getSeconds()).padStart(2,"0");return e(t)+" "+t.getDate()+" "+t.getFullYear()+" "+t.getHours()+":"+i+":"+a}}
//# sourceMappingURL=spbc-scanner-plugin.min.js.map
